<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>D&D Hub</title>
  <!-- Tailwind for layout -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <!-- Retro fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=VT323&family=Cormorant+Garamond:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --color-text:#E6E6E6;
      --color-header:#00FF88;
      --color-accent:#FFFFFF;
      --color-price:#FFB454;
      --color-dim:#6B7280;
      --color-border:#333333;
      --shadow-glow:0 0 8px;
      --color-bg:#0A0A0A;
      --window-bg:rgba(20,20,20,.9);
      --input-bg:#1a1a1a;
      --input-text:#fff;
      --btn-text:#000;
    }
    body{
      font-family:"VT323",monospace;
      background:var(--color-bg);
      color:var(--color-text);
      font-size:20px;
      line-height:1.6;
    }
    .cli-window{
      border:1px solid var(--color-border);
      border-radius:.375rem;
      padding:1rem;
      background:var(--window-bg);
    }
    .btn{
      background:var(--color-accent);
      color:var(--btn-text);
      padding:.5rem 1rem;
      border:none;
      border-radius:.25rem;
      cursor:pointer;
    }
    .btn:hover{background:var(--color-bg);color:var(--color-accent);box-shadow:0 0 5px var(--color-accent)}
    .input-field{
      background:var(--input-bg);
      color:var(--input-text);
      border:1px solid var(--color-border);
      padding:.5rem;
      border-radius:.25rem;
      width:100%;
    }
    .text-header{color:var(--color-header);text-shadow:var(--shadow-glow) var(--color-header)}
    .text-accent{color:var(--color-accent)}
    .text-price{color:var(--color-price);font-weight:bold}
    .text-dim{color:var(--color-dim)}
  </style>
</head>
<body class="p-4">
  <div id="toolbar" class="flex justify-between items-center mb-4">
    <div id="toolbar-title" class="text-header text-2xl"></div>
    <div class="flex gap-4">
      <button id="dm-tools-btn" class="hidden">DM Tools</button>
      <button id="logout-btn" class="hidden">Logout</button>
    </div>
  </div>

  <div id="app"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      getFirestore, doc, getDoc, setDoc, onSnapshot,
      updateDoc, collection, getDocs, query, where
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // -------------------------------------------------
    // ApiService: wrapper around Firebase calls
    // -------------------------------------------------
    const firebaseConfig = {
      apiKey: "AIzaSyDP4sp2jG8shImZYZeQLuK+cv9JcMVvlmY",
      authDomain: "dnd-shop-app-c4f86.firebaseapp.com",
      projectId: "dnd-shop-app-c4f86",
      storageBucket: "dnd-shop-app-c4f86.appspot.com",
      messagingSenderId: "724052404919",
      appId: "1:724052404919:web:2ed8aea0e43d0c95bb0f09"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const ApiService = {
      async getCharacter(key){
        const snap = await getDoc(doc(db,'characters',key));
        return snap.exists() ? snap.data() : null;
      },
      onCharacter(key,cb){
        return onSnapshot(doc(db,'characters',key), s=> cb(s.exists()?s.data():null));
      },
      saveCharacter(key,data){
        return setDoc(doc(db,'characters',key),data,{merge:true});
      },
      async getShop(id){
        const snap = await getDoc(doc(db,'shops',id));
        return snap.exists()?snap.data():null;
      },
      onShop(id,cb){
        return onSnapshot(doc(db,'shops',id), s=> cb(s.exists()?s.data():null));
      },
      saveShop(id,data){
        return setDoc(doc(db,'shops',id),data,{merge:true});
      },
      async findShopByCode(code){
        const qSnap = await getDocs(query(collection(db,'shops'), where('code','==',code)));
        return qSnap.empty ? null : { id:qSnap.docs[0].id, ...qSnap.docs[0].data() };
      }
    };

    // -------------------------------------------------
    // Store: central state container
    // -------------------------------------------------
    class Store{
      constructor(initial){
        this.state = initial;
        this.listeners = [];
      }
      getState(){ return this.state; }
      subscribe(fn){ this.listeners.push(fn); return () => { this.listeners = this.listeners.filter(l=>l!==fn); }; }
      dispatch(action){
        switch(action.type){
          case 'SET_VIEW':
            this.state.view = action.view; break;
          case 'SET_CHARACTER':
            this.state.character = action.character; break;
          case 'SET_SHOP':
            this.state.shop = action.shop; break;
          case 'SET_DM':
            this.state.isDM = action.value; break;
        }
        this.listeners.forEach(l=>l());
      }
    }
    const store = new Store({ view:'auth', character:null, shop:null, isDM:false });

    // -------------------------------------------------
    // Component helpers
    // -------------------------------------------------
    const Components = {
      abilityCard: (name, data) => `
        <div class="p-3 border border-border rounded text-center">
          <p class="text-accent text-lg">${name}</p>
          <p class="text-header text-2xl">${data.score}</p>
          <p class="text-dim">mod ${data.mod}</p>
        </div>`,
      skillRow: (name, data) => `
        <div class="flex justify-between border-b border-border py-1">
          <span>${name}</span>
          <span class="text-accent">${data.bonus}</span>
        </div>`,
      inventoryRow: (item) => `
        <div class="flex justify-between border-b border-border py-1">
          <span class="text-item-name">${item.name}</span>
          <span class="text-price">${item.price} GP</span>
        </div>`
    };

    // -------------------------------------------------
    // View renderers
    // -------------------------------------------------
    function renderAuth(){
      return `
        <div class="max-w-md mx-auto cli-window text-center">
          <h2 class="text-2xl mb-4 text-header">> Welcome Adventurer</h2>
          <input id="key-input" class="input-field mb-4" placeholder="CHARACTER KEY" maxlength="6" />
          <button id="login-btn" class="btn w-full mb-2">Enter</button>
          <button id="dm-btn" class="btn w-full">DM Hub</button>
        </div>
      `;
    }

    function renderCharacter(){
      const ch = store.getState().character;
      if(!ch) return '<p class="text-dim">Loading...</p>';
      const abilities = Object.entries(ch.sheet.abilities || {});
      const skills = Object.entries(ch.sheet.skills || {});
      return `
        <div class="space-y-6">
          <div class="cli-window">
            <h2 class="text-xl text-header mb-2">> ${ch.sheet.charname}</h2>
            <div class="grid grid-cols-2 sm:grid-cols-3 gap-2">
              ${abilities.map(([name,val])=>Components.abilityCard(name,val)).join('')}
            </div>
          </div>
          <div class="cli-window">
            <h2 class="text-xl text-header mb-2">> Skills</h2>
            ${skills.map(([name,val])=>Components.skillRow(name,val)).join('')}
          </div>
          <div class="cli-window">
            <h2 class="text-xl text-header mb-2">> Spells</h2>
            <div id="spells-list" class="space-y-1"></div>
          </div>
        </div>`;
    }

    function renderShop(){
      const shop = store.getState().shop;
      if(!shop) return '<p class="text-dim">Loading...</p>';
      const inventory = shop.inventory || [];
      return `
        <div class="space-y-6">
          <div class="cli-window">
            <h2 class="text-xl text-header mb-2">> ${shop.shopkeeper?.name || 'Shop'}</h2>
            ${inventory.length===0?'<p class="text-dim">No items.</p>':inventory.map(Components.inventoryRow).join('')}
          </div>
        </div>`;
    }

    function renderDMHub(){
      return `
        <div class="max-w-md mx-auto cli-window text-center">
          <h2 class="text-2xl mb-4 text-header">> DM Hub</h2>
          <button id="create-shop-btn" class="btn w-full mb-2">Create Shop</button>
          <button id="enter-shop-btn" class="btn w-full">Enter Shop by Code</button>
        </div>`;
    }

    function render(){
      const root = document.getElementById('app');
      switch(store.getState().view){
        case 'character': root.innerHTML = renderCharacter(); break;
        case 'shop': root.innerHTML = renderShop(); break;
        case 'dm': root.innerHTML = renderDMHub(); break;
        default: root.innerHTML = renderAuth();
      }
      lucide.createIcons();
      attachListeners();
    }

    store.subscribe(render);

    // -------------------------------------------------
    // Event listeners for rendered content
    // -------------------------------------------------
    function attachListeners(){
      const state = store.getState();
      if(state.view==='auth'){
        document.getElementById('login-btn')?.addEventListener('click', async()=>{
          const key = document.getElementById('key-input').value.trim();
          if(!key) return;
          const data = await ApiService.getCharacter(key);
          if(data){
            store.dispatch({type:'SET_CHARACTER',character:data});
            store.dispatch({type:'SET_VIEW',view:'character'});
            ApiService.onCharacter(key, ch=>{
              if(ch) store.dispatch({type:'SET_CHARACTER',character:ch});
            });
          }
        });
        document.getElementById('dm-btn')?.addEventListener('click',()=>{
          store.dispatch({type:'SET_DM',value:true});
          store.dispatch({type:'SET_VIEW',view:'dm'});
        });
      }else if(state.view==='dm'){
        document.getElementById('create-shop-btn')?.addEventListener('click',async()=>{
          const id = Math.random().toString(36).substring(2,8);
          await ApiService.saveShop(id,{ active:true, inventory:[], shopkeeper:{ name:'DM', gold:0 }});
          store.dispatch({type:'SET_VIEW',view:'shop'});
          const data = await ApiService.getShop(id);
          store.dispatch({type:'SET_SHOP',shop:data});
          ApiService.onShop(id, s=>{ if(s) store.dispatch({type:'SET_SHOP',shop:s}); });
        });
        document.getElementById('enter-shop-btn')?.addEventListener('click',async()=>{
          const code = prompt('Enter shop code');
          if(!code) return;
          const shop = await ApiService.findShopByCode(code);
          if(shop){
            store.dispatch({type:'SET_SHOP',shop});
            store.dispatch({type:'SET_VIEW',view:'shop'});
            ApiService.onShop(shop.id, s=>{ if(s) store.dispatch({type:'SET_SHOP',shop:s}); });
          }
        });
      }
    }

    // initial render
    render();
  </script>
</body>
</html>

