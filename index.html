<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-text: #E0E0E0;
            --color-header: #00FF00; /* Bright Green */
            --color-accent: #00FFFF; /* Cyan */
            --color-price: #FFD700;  /* Gold */
            --color-dim: #a0a0a0;
            --color-border: #cccccc;
            --shadow-glow: 0 0 7px;
        }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'VT323', monospace;
            background-color: #000000;
            color: var(--color-text);
            font-size: 20px;
            line-height: 1.6;
            overflow-x: hidden;
            padding-top: 5rem; /* Space for the fixed navbar */
        }
        .cli-window {
            border: 2px solid var(--color-border);
            padding: 1rem;
            background-color: rgba(10, 10, 10, 0.4);
            box-shadow: 0 0 10px rgba(204, 204, 204, 0.3);
            opacity: 0;
            transform: translateY(20px);
            animation: fadeIn 0.5s forwards;
            position: relative; /* For positioning exit buttons */
        }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
        .btn {
            display: inline-block;
            padding: 0.75rem 1.25rem;
            background-color: #ffffff;
            color: #000000;
            text-shadow: none;
            cursor: pointer;
            border: none;
            transition: all 0.2s ease-in-out;
        }
        .btn:hover:not(:disabled) { background-color: #000000; color: #ffffff; box-shadow: 0 0 5px #ffffff; }
        .btn-secondary { background-color: transparent; color: #ffffff; border: 1px solid #ffffff; }
        .btn-secondary:hover { background-color: #ffffff; color: #000000; }
        .btn:disabled { background-color: #333; color: #888; cursor: not-allowed; opacity: 0.7; }
        .input-field, .select-field {
            background-color: #111;
            border: 1px solid #ffffff;
            color: #ffffff;
            padding: 0.75rem;
            width: 100%;
            font-family: 'VT323', monospace;
            text-transform: uppercase;
        }
        .input-field:focus, .select-field:focus { outline: none; box-shadow: 0 0 8px #ffffff; }
        .ascii-title {
            font-family: monospace; 
            white-space: pre;
            text-align: center;
            font-size: clamp(0.8rem, 4vw, 1.5rem);
            margin-bottom: 1rem;
            color: var(--color-header);
            text-shadow: var(--shadow-glow) var(--color-header);
        }
        .text-header { color: var(--color-header); text-shadow: var(--shadow-glow) var(--color-header); }
        .text-item-name { color: var(--color-accent); }
        .text-price { color: var(--color-price); font-weight: bold; }
        .text-dim { color: var(--color-dim); }
        .link-style { background: none; border: none; color: var(--color-accent); cursor: pointer; text-decoration: underline; }
        #dm-tools-btn { background: none; border: none; color: white; font-size: 1.25rem; cursor: pointer; }
        #dm-tools-btn:hover { text-decoration: underline; }
        .dropdown-link {
            background: none;
            border: none;
            color: var(--color-text);
            cursor: pointer;
            text-align: left;
            width: 100%;
            padding: 0.5rem;
            font-size: 1.1rem;
        }
        .dropdown-link:hover {
            background-color: rgba(255,255,255,0.1);
            color: var(--color-accent);
        }
        #exit-mode-btn { background: none; border: none; color: var(--color-header); font-size: 1.75rem; line-height: 1; cursor: pointer; padding: 0 0.5rem; }
        #exit-mode-btn:hover { color: white; }
        .subview-exit-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: none;
            border: none;
            color: var(--color-header);
            font-size: 1.75rem;
            line-height: 1;
            cursor: pointer;
            padding: 0.25rem;
        }
        .subview-exit-btn:hover { color: white; }
        .item-card { transition: transform 0.3s ease-out, box-shadow 0.3s ease-out, opacity 0.3s; touch-action: pan-y; }
        .item-card.sold-out { opacity: 0.5; }
        .item-card.swiping { transition: none; }
        @keyframes glow-success { 0% { box-shadow: 0 0 0px var(--color-header); } 50% { box-shadow: 0 0 15px var(--color-header); } 100% { box-shadow: 0 0 0px var(--color-header); } }
        .glow-once { animation: glow-success 0.7s ease-out; }
    </style>
</head>
<body class="p-4 sm:p-6 lg:p-8">

    <div id="toolbar" class="fixed top-0 left-0 right-0 bg-black p-4 z-50 flex justify-between items-center h-20">
        <div id="toolbar-title" class="text-2xl hidden text-header"></div>
        <div id="controls-container" class="relative ml-auto">
             <button id="dm-tools-btn">DM Tools</button>
             <div id="dm-tools-dropdown" class="hidden absolute right-0 mt-2 w-56 bg-black cli-window">
                 <button id="create-new-shop-btn" class="dropdown-link mb-2">> Create New Shop</button>
                 <button id="view-keys-btn" class="dropdown-link">> View Character Keys</button>
             </div>
             <button id="exit-mode-btn" class="hidden">ⓧ</button>
        </div>
    </div>

    <div id="app-container" class="max-w-7xl mx-auto">
        <!-- Auth View -->
        <div id="auth-view">
             <div class="ascii-title">
██████╗ ███╗   ██╗██████╗     ██╗  ██╗██╗   ██╗██████╗ 
██╔══██╗████╗  ██║██╔══██╗    ██║  ██║██║   ██║██╔══██╗
██║  ██║██╔██╗ ██║██║  ██║    ███████║██║   ██║██████╔╝
██║  ██║██║╚██╗██║██║  ██║    ██╔══██║██║   ██║██╔══██╗
██████╔╝██║ ╚████║██████╔╝    ██║  ██║╚██████╔╝██████╔╝
╚═════╝ ╚═╝  ╚═══╝╚═════╝     ╚═╝  ╚═╝ ╚═════╝ ╚═════╝ 
                                                       
            </div>
            <div id="login-container" class="max-w-md mx-auto mb-8 cli-window text-center">
                <h2 class="text-2xl mb-4 text-header">> Welcome, Adventurer!</h2>
                <div class="flex flex-col sm:flex-row gap-2">
                    <input type="text" id="character-key-input" class="input-field flex-grow" placeholder="ENTER CHARACTER KEY" maxlength="6">
                    <button id="login-key-btn" class="btn">Enter</button>
                </div>
                <p class="my-4 text-dim">-- OR --</p>
                <button id="create-character-btn" class="btn w-full">Create New Character</button>
            </div>
        </div>

        <!-- Character Hub View -->
        <div id="character-hub-view" class="hidden"></div>
        <!-- Create Shop View -->
        <div id="create-shop-view" class="hidden max-w-md mx-auto"></div>
        <!-- DM View -->
        <div id="dm-view" class="hidden"></div>
        <!-- Player View -->
        <div id="player-view" class="hidden"></div>
        <!-- DM Keys View -->
        <div id="dm-keys-view" class="hidden"></div>
    </div>

    <!-- New Key Modal (Moved outside app-container) -->
    <div id="new-key-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-[100] p-4">
        <div class="cli-window w-full max-w-md text-center">
            <h2 class="text-2xl font-bold mb-4 text-header">> Your New Character Key!</h2>
            <p class="mb-4 text-dim">> This is your secret key. Write it down! It is the ONLY way to access your character again.</p>
            <div class="bg-gray-900 p-4 border-2 border-dashed border-header mb-6">
                <p id="new-key-display" class="text-4xl text-header tracking-widest"></p>
            </div>
            <button id="key-modal-continue-btn" class="btn w-full">Continue to Hub</button>
        </div>
    </div>
 
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, getDoc, runTransaction, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyA4KsHgYxihH0fgsSET1kcnONHxtlInZIE",
          authDomain: "dnd-shop-app-c4f86.firebaseapp.com",
          projectId: "dnd-shop-app-c4f86",
          storageBucket: "dnd-shop-app-c4f86.appspot.com",
          messagingSenderId: "480358969004",
          appId: "1:480358969004:web:51e08541ec64dc4b4a7909",
          measurementId: "G-DWLMWMZTZ3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const itemCatalog = {
          "blacksmith": { "name": "Blacksmith/Armory", "items": [ { "name": "Studded Leather", "price": 45 }, { "name": "Chain Shirt", "price": 50 }, { "name": "Scale Mail", "price": 50 }, { "name": "Breastplate", "price": 400 }, { "name": "Half Plate", "price": 750 }, { "name": "Ring Mail", "price": 30 }, { "name": "Chain Mail", "price": 75 }, { "name": "Splint", "price": 200 }, { "name": "Plate", "price": 1500 }, { "name": "Shield", "price": 10 }, { "name": "Dagger", "price": 2 }, { "name": "Handaxe", "price": 5 }, { "name": "Javelin", "price": 0.5 }, { "name": "Light Hammer", "price": 2 }, { "name": "Mace", "price": 5 }, { "name": "Sickle", "price": 1 }, { "name": "Spear", "price": 1 }, { "name": "Battleaxe", "price": 10 }, { "name": "Flail", "price": 10 }, { "name": "Glaive", "price": 20 }, { "name": "Greataxe", "price": 30 }, { "name": "Greatsword", "price": 50 }, { "name": "Halberd", "price": 20 }, { "name": "Lance", "price": 10 }, { "name": "Longsword", "price": 15 }, { "name": "Maul", "price": 10 }, { "name": "Morningstar", "price": 15 }, { "name": "Pike", "price": 5 }, { "name": "Rapier", "price": 25 }, { "name": "Scimitar", "price": 25 }, { "name": "Shortsword", "price": 10 }, { "name": "Trident", "price": 5 }, { "name": "War Pick", "price": 5 }, { "name": "Warhammer", "price": 15 }, { "name": "Ball Bearings (bag of 1,000)", "price": 1 }, { "name": "Bell", "price": 1 }, { "name": "Block and Tackle", "price": 1 }, { "name": "Chain (10 feet)", "price": 5 }, { "name": "Crowbar", "price": 2 }, { "name": "Grappling Hook", "price": 2 }, { "name": "Hammer", "price": 1 }, { "name": "Sledgehammer", "price": 2 }, { "name": "Hunting Trap", "price": 5 }, { "name": "Lamp", "price": 0.5 }, { "name": "Lantern, Bullseye", "price": 10 }, { "name": "Lantern, Hooded", "price": 5 }, { "name": "Lock", "price": 10 }, { "name": "Manacles", "price": 2 }, { "name": "Mirror, Steel", "price": 5 }, { "name": "Pick, Miner's", "price": 2 }, { "name": "Piton", "price": 0.05 }, { "name": "Pot, Iron", "price": 2 }, { "name": "Spikes, Iron", "price": 1 }, { "name": "Whetstone", "price": 0.01 }, { "name": "Carpenter's Tools", "price": 8 }, { "name": "Mason's Tools", "price": 10 }, { "name": "Smith's Tools", "price": 20 }, { "name": "Tinker's Tools", "price": 50 }, { "name": "Horn", "price": 3 } ] },
          "fletcher": { "name": "Fletcher/Bowyer", "items": [ { "name": "Crossbow, Light", "price": 25 }, { "name": "Shortbow", "price": 25 }, { "name": "Crossbow, Hand", "price": 75 }, { "name": "Crossbow, Heavy", "price": 50 }, { "name": "Longbow", "price": 50 }, { "name": "Arrows (20)", "price": 1 }, { "name": "Crossbow Bolts (20)", "price": 1 }, { "name": "Case, Crossbow Bolt", "price": 1 }, { "name": "Quiver", "price": 1 } ] },
          "leathersmith": { "name": "Leathersmith/Tanner", "items": [ { "name": "Leather", "price": 10 }, { "name": "Studded Leather", "price": 45 }, { "name": "Hide", "price": 10 }, { "name": "Shield", "price": 10 }, { "name": "Sling", "price": 0.1 }, { "name": "Waterskin", "price": 0.2 }, { "name": "Cobbler's Tools", "price": 5 }, { "name": "Leatherworker's Tools", "price": 5 }, { "name": "Bagpipes", "price": 30 }, { "name": "Drum", "price": 6 } ] },
          "temple": { "name": "Temple/Priest", "items": [ { "name": "Alms Box", "price": 5 }, { "name": "Bell", "price": 1 }, { "name": "Blanket", "price": 0.5 }, { "name": "Book, Scripture", "price": 25 }, { "name": "Candle", "price": 0.01 }, { "name": "Case, Map or Scroll", "price": 1 }, { "name": "Censer", "price": 5 }, { "name": "Chalk (1 piece)", "price": 0.01 }, { "name": "Flask", "price": 0.02 }, { "name": "Healer's Kit", "price": 5 }, { "name": "Holy Symbol, Amulet", "price": 5 }, { "name": "Holy Symbol, Emblem", "price": 5 }, { "name": "Holy Symbol, Reliquary", "price": 5 }, { "name": "Holy Water (flask)", "price": 25 }, { "name": "Incense (1 block)", "price": 0.01 }, { "name": "Ink (1 ounce bottle)", "price": 10 }, { "name": "Ink Pen", "price": 0.02 }, { "name": "Lamp", "price": 0.5 }, { "name": "Lantern, Hooded", "price": 5 }, { "name": "Oil (flask)", "price": 0.1 }, { "name": "Paper (one sheet)", "price": 0.2 }, { "name": "Parchment (one sheet)", "price": 0.1 }, { "name": "Perfume (vial)", "price": 5 }, { "name": "Potion of Healing", "price": 50 }, { "name": "Rations (1 day)", "price": 0.5 }, { "name": "Torch", "price": 0.01 }, { "name": "Vial", "price": 1 }, { "name": "Waterskin", "price": 0.2 }, { "name": "Calligrapher's Supplies", "price": 10 }, { "name": "Herbalism Kit", "price": 5 }, { "name": "Flute", "price": 2 }, { "name": "Lyre", "price": 30 }, { "name": "Horn", "price": 3 }, { "name": "Cure Wounds (lvl 1)", "price": 10, "type": "service" }, { "name": "Gentle Repose (lvl 2)", "price": 50, "type": "service" }, { "name": "Lesser Restoration (lvl 2)", "price": 50, "type": "service" }, { "name": "Remove Curse (lvl 3)", "price": 100, "type": "service" }, { "name": "Revivify (lvl 3)", "price": 400, "type": "service" }, { "name": "Raise Dead (lvl 5)", "price": 1000, "type": "service" } ] },
          "general_store": { "name": "General Store", "items": [ { "name": "Abacus", "price": 2 }, { "name": "Barrel", "price": 2 }, { "name": "Blanket", "price": 0.5 }, { "name": "Bottle, glass", "price": 2 }, { "name": "Bucket", "price": 0.05 }, { "name": "Candle", "price": 0.01 }, { "name": "Chest", "price": 5 }, { "name": "Clothes, Common", "price": 0.5 }, { "name": "Clothes, Fine", "price": 15 }, { "name": "Flask or Tankard", "price": 0.02 }, { "name": "Hammer", "price": 1 }, { "name": "Ink (1 ounce bottle)", "price": 10 }, { "name": "Ink Pen", "price": 0.02 }, { "name": "Jug or Pitcher", "price": 0.02 }, { "name": "Ladder (10-foot)", "price": 0.1 }, { "name": "Lantern, Hooded", "price": 5 }, { "name": "Lamp", "price": 0.5 }, { "name": "Lock", "price": 10 }, { "name": "Mess Kit", "price": 0.2 }, { "name": "Mirror, Steel", "price": 5 }, { "name": "Paper (one sheet)", "price": 0.2 }, { "name": "Parchment (one sheet)", "price": 0.1 }, { "name": "Pick, Miner's", "price": 2 }, { "name": "Pot, Iron", "price": 2 }, { "name": "Pouch", "price": 0.5 }, { "name": "Rope, Hempen (50 feet)", "price": 1 }, { "name": "Rope, Silk (50 feet)", "price": 10 }, { "name": "Sack", "price": 0.01 }, { "name": "Scale, Merchant's", "price": 5 }, { "name": "Shovel", "price": 2 }, { "name": "Signet Ring", "price": 5 }, { "name": "Soap", "price": 0.02 }, { "name": "Vial", "price": 1 }, { "name": "Carpenter's Tools", "price": 15 }, { "name": "Cobbler's Tools", "price": 25 }, { "name": "Cook's Utensils", "price": 50 }, { "name": "Glassblower's Tools", "price": 30 }, { "name": "Leatherworker's Tools", "price": 5 }, { "name": "Mason's Tools", "price": 10 }, { "name": "Potter's Tools", "price": 10 }, { "name": "Smith's Tools", "price": 20 }, { "name": "Weaver's Tools", "price": 1 }, { "name": "Woodcarver's Tools", "price": 1 } ] },
          "adventuring_supplies": { "name": "Adventuring Supplies", "items": [ { "name": "Padded Armor", "price": 5 }, { "name": "Leather Armor", "price": 10 }, { "name": "Studded Leather", "price": 45 }, { "name": "Hide Armor", "price": 10 }, { "name": "Club", "price": 0.1 }, { "name": "Dagger", "price": 2 }, { "name": "Greatclub", "price": 0.2 }, { "name": "Handaxe", "price": 5 }, { "name": "Light Hammer", "price": 2 }, { "name": "Quarterstaff", "price": 0.2 }, { "name": "Crossbow, Light", "price": 25 }, { "name": "Dart", "price": 0.05 }, { "name": "Shortbow", "price": 25 }, { "name": "Sling", "price": 0.1 }, { "name": "Whip", "price": 2 }, { "name": "Blowgun", "price": 10 }, { "name": "Crossbow, Hand", "price": 75 }, { "name": "Crossbow, Heavy", "price": 50 }, { "name": "Longbow", "price": 50 }, { "name": "Arrows (20)", "price": 1 }, { "name": "Blowgun Needles (50)", "price": 1 }, { "name": "Crossbow Bolts (20)", "price": 1 }, { "name": "Sling Bullets (20)", "price": 0.04 }, { "name": "Backpack", "price": 2 }, { "name": "Bedroll", "price": 1 }, { "name": "Blanket", "price": 0.5 }, { "name": "Block and Tackle", "price": 1 }, { "name": "Bottle, glass", "price": 2 }, { "name": "Candle", "price": 0.01 }, { "name": "Case, Crossbow Bolt", "price": 1 }, { "name": "Case, Map or Scroll", "price": 1 }, { "name": "Chain (10 feet)", "price": 5 }, { "name": "Chest", "price": 5 }, { "name": "Climber's Kit", "price": 25 }, { "name": "Clothes, Traveler's", "price": 2 }, { "name": "Crowbar", "price": 2 }, { "name": "Flask or Tankard", "price": 0.02 }, { "name": "Grappling Hook", "price": 2 }, { "name": "Hammer", "price": 1 }, { "name": "Healer's Kit", "price": 5 }, { "name": "Hourglass", "price": 25 }, { "name": "Hunting Trap", "price": 5 }, { "name": "Ink (1 ounce bottle)", "price": 10 }, { "name": "Ink Pen", "price": 0.02 }, { "name": "Jug or Pitcher", "price": 0.02 }, { "name": "Ladder (10-foot)", "price": 0.1 }, { "name": "Lantern, Bullseye", "price": 10 }, { "name": "Lantern, Hooded", "price": 5 }, { "name": "Lock", "price": 10 }, { "name": "Mess Kit", "price": 0.2 }, { "name": "Mirror, Steel", "price": 5 }, { "name": "Paper (one sheet)", "price": 0.2 }, { "name": "Parchment (one sheet)", "price": 0.1 }, { "name": "Pick, Miner's", "price": 2 }, { "name": "Piton", "price": 0.05 }, { "name": "Pole (10-foot)", "price": 0.05 }, { "name": "Pot, Iron", "price": 2 }, { "name": "Pouch", "price": 0.5 }, { "name": "Quiver", "price": 1 }, { "name": "Rations (1 day)", "price": 0.5 }, { "name": "Rope, Hempen (50 feet)", "price": 1 }, { "name": "Rope, Silk (50 feet)", "price": 10 }, { "name": "Sack", "price": 0.01 }, { "name": "Shovel", "price": 2 }, { "name": "Signal Whistle", "price": 5 }, { "name": "Signet Ring", "price": 5 }, { "name": "Spyglass", "price": 1000 }, { "name": "Tent, Two-person", "price": 2 }, { "name": "Tinderbox", "price": 0.5 }, { "name": "Torch", "price": 0.01 }, { "name": "Vial", "price": 1 }, { "name": "Waterskin", "price": 0.2 }, { "name": "Cartographer's Tools", "price": 15 }, { "name": "Jeweler's Tools", "price": 25 }, { "name": "Tinker's Tools", "price": 50 }, { "name": "Herbalism Kit", "price": 5 }, { "name": "Navigator's Tools", "price": 25 } ] },
          "arcane_shop": { "name": "Arcane Shop", "items": [ { "name": "Crystal", "price": 10 }, { "name": "Orb", "price": 20 }, { "name": "Rod", "price": 10 }, { "name": "Staff", "price": 5 }, { "name": "Wand", "price": 10 }, { "name": "Component Pouch", "price": 25 }, { "name": "Potion of Healing", "price": 50 }, { "name": "Spellbook", "price": 50 } ] },
          "thieves_guild": { "name": "Thieves' Guild", "items": [ { "name": "Acid (vial)", "price": 25 }, { "name": "Antitoxin (vial)", "price": 50 }, { "name": "Caltrops (bag of 20)", "price": 1 }, { "name": "Clothes, Costume", "price": 5 }, { "name": "Manacles", "price": 2 }, { "name": "Oil (flask)", "price": 0.1 }, { "name": "Poison, Basic (vial)", "price": 100 }, { "name": "Ram, Portable", "price": 4 }, { "name": "Spikes, Iron (10)", "price": 1 }, { "name": "Disguise Kit", "price": 25 }, { "name": "Forgery Kit", "price": 15 }, { "name": "Dice Set", "price": 0.1 }, { "name": "Playing Card Set", "price": 0.5 }, { "name": "Poisoner's Kit", "price": 50 }, { "name": "Thieves' Tools", "price": 25 } ] },
          "potion_shop": { "name": "Potion Shop", "items": [ { "name": "Acid (vial)", "price": 25 }, { "name": "Alchemist's Fire (flask)", "price": 50 }, { "name": "Antitoxin (vial)", "price": 50 }, { "name": "Bottle, glass", "price": 2 }, { "name": "Component Pouch", "price": 25 }, { "name": "Flask", "price": 0.02 }, { "name": "Healer's Kit", "price": 5 }, { "name": "Ink (1 ounce bottle)", "price": 10 }, { "name": "Jug", "price": 0.02 }, { "name": "Oil (flask)", "price": 0.1 }, { "name": "Perfume (vial)", "price": 5 }, { "name": "Poison, Basic (vial)", "price": 100 }, { "name": "Potion of Healing", "price": 50 }, { "name": "Vial", "price": 1 }, { "name": "Alchemist's Supplies", "price": 50 }, { "name": "Brewer's Supplies", "price": 20 }, { "name": "Cook's Utensils", "price": 1 }, { "name": "Poisoner's Kit", "price": 50 }, { "name": "Potion (Common)", "price": 50 }, { "name": "Potion (Uncommon)", "price": 250 }, { "name": "Potion (Rare)", "price": 2500 } ] }
        };

        let shopUnsubscribe = null;
        let playerUnsubscribe = null;

        let state = {
            isDM: false,
            inShop: false,
            characterKey: null,
            playerData: null,
            shopId: null,
            shopData: null,
        };

        // DOM Elements
        const allViews = document.querySelectorAll('#app-container > div');
        const authView = document.getElementById('auth-view');
        const characterHubView = document.getElementById('character-hub-view');
        const createShopView = document.getElementById('create-shop-view');
        const dmView = document.getElementById('dm-view');
        const playerView = document.getElementById('player-view');
        const dmKeysView = document.getElementById('dm-keys-view');
        const toolbarTitle = document.getElementById('toolbar-title');
        const controlsContainer = document.getElementById('controls-container');
        const dmToolsBtn = document.getElementById('dm-tools-btn');
        const dmToolsDropdown = document.getElementById('dm-tools-dropdown');
        const createNewShopBtn = document.getElementById('create-new-shop-btn');
        const viewKeysBtn = document.getElementById('view-keys-btn');
        const exitModeBtn = document.getElementById('exit-mode-btn');
        const newKeyModal = document.getElementById('new-key-modal');

        function toggleDmTools() {
            dmToolsDropdown.classList.toggle('hidden');
        }

        // --- Initialization ---
        function main() {
            // Auth
            document.getElementById('login-key-btn').addEventListener('click', handleKeyLogin);
            document.getElementById('create-character-btn').addEventListener('click', handleCreateCharacter);
            document.getElementById('key-modal-continue-btn').addEventListener('click', () => {
                newKeyModal.classList.add('hidden');
                if (state.characterKey) {
                    listenToPlayerData(state.characterKey);
                }
            });

            // DM
            createNewShopBtn.addEventListener('click', showCreateShopView);
            viewKeysBtn.addEventListener('click', showAllKeys);
            exitModeBtn.addEventListener('click', exitCurrentMode);

            // Check for saved key
            const savedKey = localStorage.getItem('dndShopCharacterKey');
            if (savedKey) {
                loginWithKey(savedKey);
            }

            render();
        }

        // --- Auth & Character Functions ---
        async function handleKeyLogin() {
            const key = document.getElementById('character-key-input').value.toUpperCase();
            if (key.length !== 6) { alert("Please enter a valid 6-character key."); return; }
            await loginWithKey(key);
        }

        async function loginWithKey(key) {
            const playerDocRef = doc(db, 'characters', key);
            const docSnap = await getDoc(playerDocRef);
            if (docSnap.exists()) {
                state.characterKey = key;
                localStorage.setItem('dndShopCharacterKey', key);
                listenToPlayerData(key);
            } else {
                alert("Character key not found.");
            }
        }

        async function handleCreateCharacter() {
            const key = Math.random().toString(36).substring(2, 8).toUpperCase();
            const playerDocRef = doc(db, 'characters', key);
            
            try {
                await setDoc(playerDocRef, {
                    name: "Adventurer",
                    gold: 50,
                    inventory: []
                });
                document.getElementById('new-key-display').textContent = key;
                newKeyModal.classList.remove('hidden');
                state.characterKey = key;
                localStorage.setItem('dndShopCharacterKey', key);
            } catch (error) {
                console.error("Error creating character:", error);
                alert("Could not create character. Please try again.");
            }
        }

        function listenToPlayerData(key) {
            if (playerUnsubscribe) playerUnsubscribe();
            const playerDocRef = doc(db, 'characters', key);
            playerUnsubscribe = onSnapshot(playerDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    state.playerData = docSnap.data();
                } else {
                    alert("Character data lost or deleted.");
                    logout();
                }
                render();
            });
        }

        function logout() {
            if (playerUnsubscribe) playerUnsubscribe();
            localStorage.removeItem('dndShopCharacterKey');
            state.characterKey = null;
            state.playerData = null;
            exitCurrentMode();
        }

        // --- Core App Logic ---
        function exitSubView() {
            createShopView.classList.add('hidden');
            dmKeysView.classList.add('hidden');
            render(); // This will show the correct main view (auth or hub)
        }

        function showCreateShopView() {
            dmToolsDropdown.classList.add('hidden');
            authView.classList.add('hidden');
            characterHubView.classList.add('hidden');
            createShopView.classList.remove('hidden');
            createShopView.innerHTML = `
                <div class="cli-window">
                    <button id="exit-create-shop-btn" class="subview-exit-btn">ⓧ</button>
                    <h2 class="text-2xl mb-4 text-header">> Create a New Shop</h2>
                    <div class="space-y-4">
                        <div><label for="shop-type-select" class="block mb-1">> Shop Type</label><select id="shop-type-select" class="select-field">${Object.keys(itemCatalog).map(key => `<option value="${key}">${itemCatalog[key].name}</option>`).join('')}</select></div>
                        <div><label for="shop-size-select" class="block mb-1">> Shop Size</label><select id="shop-size-select" class="select-field">${['Small', 'Urban', 'Specialty'].map(size => `<option value="${size.toLowerCase()}">${size}</option>`).join('')}</select></div>
                        <button id="generate-shop-btn" class="btn w-full">Go</button>
                    </div>
                </div>`;
            document.getElementById('generate-shop-btn').addEventListener('click', handleGenerateShop);
            document.getElementById('exit-create-shop-btn').addEventListener('click', exitSubView);
        }
        
        async function showAllKeys() {
            dmToolsDropdown.classList.add('hidden');
            authView.classList.add('hidden');
            characterHubView.classList.add('hidden');
            dmKeysView.classList.remove('hidden');
            dmKeysView.innerHTML = `<div class="cli-window">
                <button id="exit-keys-view-btn" class="subview-exit-btn">ⓧ</button>
                <h2 class="text-header text-2xl mb-4">> All Character Keys</h2>
                <div id="keys-list">Loading...</div>
            </div>`;
            document.getElementById('exit-keys-view-btn').addEventListener('click', exitSubView);
            
            try {
                const querySnapshot = await getDocs(collection(db, "characters"));
                const keysList = document.getElementById('keys-list');
                keysList.innerHTML = querySnapshot.docs.map(doc => {
                    const data = doc.data();
                    return `<p><span class="text-item-name">${data.name}</span>: <span class="text-header">${doc.id}</span></p>`
                }).join('');
            } catch (error) {
                document.getElementById('keys-list').innerHTML = `<p class="text-red-500">Could not load keys.</p>`;
                console.error("Error fetching keys:", error);
            }
        }

        function handleGenerateShop() {
            const shopKey = document.getElementById('shop-type-select').value;
            const shopSize = document.getElementById('shop-size-select').value;
            createShopView.classList.add('hidden');
            createSession(shopKey, shopSize);
        }

        function exitCurrentMode() {
            if (shopUnsubscribe) { shopUnsubscribe(); shopUnsubscribe = null; }
            state.isDM = false;
            state.inShop = false;
            state.shopId = null;
            state.shopData = null;
            render(); 
        }

        async function createSession(shopKey, shopSize) {
            state.isDM = true;
            state.inShop = true;
            
            const shopTemplate = itemCatalog[shopKey];
            const fullInventory = shopTemplate.items;
            let randomInventory = [];
            if (shopSize === 'small') {
                const shuffled = fullInventory.sort(() => 0.5 - Math.random());
                randomInventory = shuffled.slice(0, Math.floor(Math.random() * 8) + 5);
            } else if (shopSize === 'urban') {
                const shuffled = fullInventory.sort(() => 0.5 - Math.random());
                const min = Math.ceil(fullInventory.length * 0.4);
                const max = Math.floor(fullInventory.length * 0.8);
                randomInventory = shuffled.slice(0, Math.floor(Math.random() * (max - min + 1)) + min);
            } else {
                const sorted = [...fullInventory].sort((a, b) => b.price - a.price);
                randomInventory = sorted.slice(0, Math.floor(Math.random() * 5) + 3);
            }

            const finalInventory = randomInventory.map(item => ({
                ...item, 
                quantity: Math.floor(Math.random() * 5) + 1,
                id: `item-${Math.random().toString(36).substr(2, 9)}`
            }));
            
            state.shopId = Math.random().toString(36).substring(2, 8).toUpperCase();
            const newSessionRef = doc(db, 'shops', state.shopId);
            const initialShopData = {
                shopType: shopTemplate.name,
                shopkeeper: { gold: Math.floor(Math.random() * 1501) + 500, description: "..." },
                inventory: finalInventory,
                carts: {},
                priceModifier: 0,
            };

            state.shopData = initialShopData;

            try {
                await setDoc(newSessionRef, initialShopData);
                listenToShopChanges(state.shopId);
                render();
            } catch (error) {
                console.error("Error creating session:", error);
                alert("Error creating session.");
                exitCurrentMode();
            }
        }
        
        async function handlePlayerJoinAttempt() {
            const shopId = document.getElementById('hub-join-shop-id-input').value.trim().toUpperCase();
            if (shopId.length !== 6) { alert("Please enter a valid 6-character Shop ID."); return; }
            const shopDocRef = doc(db, 'shops', shopId);
            const docSnap = await getDoc(shopDocRef);
            if (docSnap.exists()) {
                state.shopId = shopId;
                state.inShop = true;
                listenToShopChanges(shopId);
            } else {
                alert("Shop ID not found.");
            }
        }

        function listenToShopChanges(shopId) {
            if (shopUnsubscribe) shopUnsubscribe(); 
            const shopDocRef = doc(db, 'shops', shopId);
            shopUnsubscribe = onSnapshot(shopDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    state.shopData = docSnap.data();
                    render();
                } else {
                    alert("Shop session has ended.");
                    exitCurrentMode();
                }
            }, (error) => {
                console.error("Firestore listener error:", error);
                alert("Connection to shop lost.");
                exitCurrentMode();
            });
        }
        
        // --- RENDER FUNCTIONS ---
        function render() {
            const loggedIn = !!state.characterKey;
            const inShop = state.inShop;

            allViews.forEach(v => v.classList.add('hidden'));
            
            controlsContainer.classList.remove('hidden');
            dmToolsDropdown.classList.add('hidden');

            if (inShop) {
                dmToolsBtn.classList.add('hidden');
                dmToolsBtn.onclick = null;
                exitModeBtn.classList.remove('hidden');
                toolbarTitle.classList.remove('hidden');
                toolbarTitle.textContent = state.isDM ? '> DM Mode' : '> Player Mode';
            } else {
                exitModeBtn.classList.add('hidden');
                toolbarTitle.classList.add('hidden');
                dmToolsBtn.classList.remove('hidden');
                dmToolsBtn.onclick = null;
                if (loggedIn) {
                    dmToolsBtn.textContent = "Logout";
                    dmToolsBtn.onclick = logout;
                } else {
                    dmToolsBtn.textContent = "DM Tools";
                    dmToolsBtn.onclick = toggleDmTools;
                }
            }
            
            if (inShop) {
                if (state.isDM) {
                    dmView.classList.remove('hidden');
                    renderDMView();
                } else {
                    playerView.classList.remove('hidden');
                    renderPlayerView();
                }
            } else if (loggedIn) {
                characterHubView.classList.remove('hidden');
                renderCharacterHub();
            } else {
                authView.classList.remove('hidden');
            }
        }

        function renderCharacterHub() {
            const player = state.playerData;
            if (!player) {
                characterHubView.innerHTML = `<div class="cli-window text-center"><p class="text-header">Loading Character...</p></div>`;
                return;
            }
            const inventorySummary = player.inventory.reduce((acc, item) => {
                acc[item.name] = (acc[item.name] || 0) + 1;
                return acc;
            }, {});

            characterHubView.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="cli-window">
                        <h2 class="text-2xl text-header mb-2">> ${player.name}</h2>
                        <p class="text-dim">Key: <span class="text-header">${state.characterKey}</span></p>
                        <p class="text-2xl text-price mt-2">${player.gold} GP</p>
                    </div>
                    <div class="cli-window">
                        <h3 class="text-2xl text-header mb-4">> Inventory</h3>
                        <div class="space-y-2 max-h-60 overflow-y-auto">${Object.keys(inventorySummary).length === 0 ? '<p class="text-dim">Empty.</p>' : Object.entries(inventorySummary).map(([name, count]) => `<div><span class="text-item-name">${name}</span> <span class="text-dim">(x${count})</span></div>`).join('')}</div>
                    </div>
                </div>
                <div class="mt-8 cli-window max-w-md mx-auto">
                     <h2 class="text-2xl mb-4 text-header">> Enter a Shop</h2>
                    <div class="flex flex-col sm:flex-row gap-2">
                        <input type="text" id="hub-join-shop-id-input" class="input-field flex-grow" placeholder="ENTER SHOP ID" maxlength="6">
                        <button id="hub-join-shop-btn" class="btn">Enter</button>
                    </div>
                </div>
            `;
            document.getElementById('hub-join-shop-btn').addEventListener('click', handlePlayerJoinAttempt);
        }
        
        function getModifiedPrice(basePrice) {
            const modifier = state.shopData?.priceModifier || 0;
            const modified = basePrice * (1 + modifier / 100);
            return Math.round(modified * 100) / 100;
        }

        function renderDMView() {
            const { shopkeeper, inventory, carts, shopType, priceModifier } = state.shopData;
            dmView.innerHTML = `<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 text-lg">
                <div class="lg:col-span-1 flex flex-col gap-6">
                    <div class="cli-window"><h2 class="text-2xl mb-4 text-header">> DM Controls</h2><p class="mb-1">> Shop Type: ${shopType}</p><p class="mb-2">> Shop ID:</p><div class="flex gap-2"><input type="text" readonly value="${state.shopId}" id="session-id-input" class="input-field flex-grow"><button id="copy-id-btn" class="btn btn-secondary">Copy</button></div><div class="mt-4"><label for="price-modifier" class="block mb-1">> Price Modifier: <span id="price-modifier-label">${priceModifier}%</span></label><input type="range" id="price-modifier" min="-50" max="100" value="${priceModifier}" class="w-full"></div></div>
                    <div class="cli-window"><h3 class="text-2xl mb-4 text-header">> Shopkeeper</h3><p class="text-dim">> Desc: ${shopkeeper.description||'...'}</p><div class="flex items-center gap-2 mt-2"><p class="whitespace-nowrap">> Gold:</p><input type="number" id="shop-gold-input" value="${shopkeeper.gold}" class="input-field text-price"></div></div>
                </div>
                <div class="lg:col-span-1 flex flex-col gap-6">
                    <div class="cli-window"><h3 class="text-2xl mb-4 text-header">> Shop Inventory</h3><div id="dm-inventory-list" class="space-y-4">${inventory.map((item,index)=>`<div class="item-card ${item.quantity === 0 ? 'sold-out' : ''} border border-white/50 p-3" data-index="${index}"><p><span class="text-item-name">${item.name}</span> (x${item.quantity})</p><p class="text-price">${getModifiedPrice(item.price)} GP</p></div>`).join('')}</div></div>
                </div>
                <div class="lg:col-span-1 flex flex-col gap-6">
                    <div class="cli-window"><h3 class="text-2xl mb-4 text-header">> Player Carts</h3><div id="player-carts-list" class="space-y-4">${Object.keys(carts || {}).length===0?'<p class="text-dim">No active carts.</p>':Object.entries(carts).map(([playerId,cartData])=>`<div><h4 class="text-xl text-header">${cartData.playerName}</h4>${cartData.items.length > 0 ? `<ul class="pl-4 list-disc list-inside">${cartData.items.map(item=>`<li><span class="text-item-name">${item.name}</span></li>`).join('')}</ul><p class="mt-2 text-right">> Cart Total: <span class="text-price">${cartData.items.reduce((sum,item)=>sum+getModifiedPrice(item.price),0)} GP</span></p><button class="btn w-full mt-3 checkout-btn" data-player-id="${playerId}">Checkout</button>` : ''}</div>`).join('')}</div></div>
                </div>
            </div>`;
            attachDMListeners();
        }

        function renderPlayerView() {
            const { shopkeeper, inventory, carts, shopType } = state.shopData;
            const playerCart = carts[state.characterKey] || { items: [] };
            const cartTotal = playerCart.items.reduce((sum, item) => sum + getModifiedPrice(item.price), 0);
            playerView.innerHTML = `<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 text-lg">
                <div class="lg:col-span-2">
                    <div class="cli-window mb-6"><h1 class="text-3xl text-header">${shopType}</h1><p class="text-xl text-dim">> ${shopkeeper.description||'...'}</p></div>
                    <div class="cli-window"><h2 class="text-2xl mb-4 text-header">> Items for Sale</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-4">${inventory.map(item=>`<div class="item-card ${item.quantity === 0 ? 'sold-out' : ''} border border-white/50 p-3 flex flex-col justify-between" data-item-id="${item.id}"><p class="text-xl"><span class="text-item-name">${item.name}</span> <span class="text-dim">(x${item.quantity})</span></p><p class="text-price">${item.quantity > 0 ? `${getModifiedPrice(item.price)} GP` : 'SOLD OUT'}</p><div class="mt-auto pt-2 flex justify-end items-center gap-2">${item.quantity > 0 ? `<button class="btn add-to-cart-btn" data-item-id="${item.id}">Add</button>`: ''}</div></div>`).join('')}</div></div>
                </div>
                <div class="lg:col-span-1">
                    <div class="cli-window sticky top-24"><h2 class="text-2xl mb-4 text-header">> ${state.playerData.name}'s Purse</h2><p class="text-2xl text-price">${state.playerData.gold} GP</p><hr class="border-white/50 my-4"><h2 class="text-2xl mb-4 text-header">> Your Cart</h2><div id="player-cart-list" class="space-y-2 mb-4 min-h-[50px]">${playerCart.items.length===0?'<p class="text-dim">Your cart is empty.</p>':playerCart.items.map((item,index)=>`<div class="flex justify-between items-center"><span>- <span class="text-item-name">${item.name}</span></span><button class="text-red-500 hover:text-red-400 remove-from-cart-btn" data-index="${index}">[X]</button></div>`).join('')}</div><hr class="border-white/50 my-4"><p class="text-xl text-right">> Total: <span class="text-price">${cartTotal} GP</span></p></div>
                </div>
            </div>`;
            attachPlayerListeners();
        }
        
        async function handleCheckout(e) {
            const playerId = e.target.dataset.playerId;
            const shopDocRef = doc(db, "shops", state.shopId);
            const playerDocRef = doc(db, "characters", playerId);

            try {
                await runTransaction(db, async (transaction) => {
                    const shopDoc = await transaction.get(shopDocRef);
                    const playerDoc = await transaction.get(playerDocRef);
                    if (!shopDoc.exists() || !playerDoc.exists()) { throw "Document not found!"; }

                    const shopData = shopDoc.data();
                    const playerData = playerDoc.data();
                    const cart = shopData.carts[playerId];
                    if (!cart || cart.items.length === 0) { return; }

                    const totalCost = cart.items.reduce((sum, item) => sum + getModifiedPrice(item.price), 0);
                    if (playerData.gold < totalCost) { throw `${playerData.name} doesn't have enough gold!`; }

                    const newShopInventory = [...shopData.inventory];
                    const purchasedItems = [];

                    for (const cartItem of cart.items) {
                        const invItem = newShopInventory.find(i => i.id === cartItem.id);
                        if (invItem && invItem.quantity > 0) {
                            invItem.quantity -= 1;
                            const { quantity, ...itemToStore } = invItem;
                            purchasedItems.push(itemToStore);
                        } else {
                            throw `Item ${cartItem.name} is sold out!`;
                        }
                    }
                    
                    transaction.update(shopDocRef, {
                        inventory: newShopInventory,
                        "shopkeeper.gold": shopData.shopkeeper.gold + totalCost,
                        [`carts.${playerId}`]: { items: [] }
                    });

                    transaction.update(playerDocRef, {
                        gold: playerData.gold - totalCost,
                        inventory: [...playerData.inventory, ...purchasedItems]
                    });
                });
            } catch (error) {
                console.error("Transaction failed: ", error);
                alert(`Checkout failed: ${error}`);
            }
        }

        function handleAddToCart(itemId) {
            const itemToAdd = state.shopData.inventory.find(item => item.id === itemId);
            if (!itemToAdd || itemToAdd.quantity <= 0) return;
            
            const playerCart = state.shopData.carts[state.characterKey] || { items: [] };
            const newItems = [...playerCart.items, itemToAdd];
            updateDoc(doc(db, 'shops', state.shopId), { 
                [`carts.${state.characterKey}`]: { playerName: state.playerData.name, items: newItems }
            });
        }

        function attachDMListeners() { 
            document.getElementById('copy-id-btn')?.addEventListener('click', () => { const input = document.getElementById('session-id-input'); input.select(); document.execCommand('copy'); alert('Shop ID copied!'); }); 
            document.getElementById('shop-gold-input')?.addEventListener('change', (e) => { const newGold = parseInt(e.target.value, 10); if (!isNaN(newGold)) updateDoc(doc(db, 'shops', state.shopId), { "shopkeeper.gold": newGold }); }); 
            document.querySelectorAll('.checkout-btn').forEach(btn => btn.addEventListener('click', handleCheckout));
            const priceModifierSlider = document.getElementById('price-modifier');
            const priceModifierLabel = document.getElementById('price-modifier-label');
            if (priceModifierSlider) {
                priceModifierSlider.addEventListener('input', () => priceModifierLabel.textContent = `${priceModifierSlider.value}%`);
                priceModifierSlider.addEventListener('change', () => updateDoc(doc(db, 'shops', state.shopId), { priceModifier: parseInt(priceModifierSlider.value, 10) }));
            }
        }
        function attachPlayerListeners() { 
            document.querySelectorAll('.add-to-cart-btn').forEach(btn => btn.addEventListener('click', (e) => {
                const card = e.target.closest('.item-card');
                handleAddToCart(card.dataset.itemId);
                card.classList.add('glow-once');
                setTimeout(() => card.classList.remove('glow-once'), 700);
            })); 
            document.querySelectorAll('.remove-from-cart-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const indexToRemove = parseInt(e.target.dataset.index, 10);
                    const playerCart = state.shopData.carts[state.characterKey];
                    if (!playerCart) return;
                    const newItems = playerCart.items.filter((_, i) => i !== indexToRemove);
                    updateDoc(doc(db, 'shops', state.shopId), { [`carts.${state.characterKey}.items`]: newItems });
                });
            }); 
        }

        main();
    </script>
</body>
</html>
