<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-text: #E0E0E0;
            --color-header: #00FF00; /* Bright Green */
            --color-accent: #00FFFF; /* Cyan */
            --color-price: #FFD700;  /* Gold */
            --color-dim: #a0a0a0;
            --color-border: #cccccc;
            --shadow-glow: 0 0 7px;
        }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'VT323', monospace;
            background-color: #000000;
            color: var(--color-text);
            font-size: 20px;
            line-height: 1.6;
            overflow-x: hidden;
            padding-top: 5rem; /* Space for the fixed navbar */
        }
        .cli-window {
            border: 2px solid var(--color-border);
            padding: 1rem;
            background-color: rgba(10, 10, 10, 0.4);
            box-shadow: 0 0 10px rgba(204, 204, 204, 0.3);
            opacity: 0;
            transform: translateY(20px);
            animation: fadeIn 0.5s forwards;
            position: relative; /* For positioning exit buttons */
        }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
        .btn {
            display: inline-block;
            padding: 0.75rem 1.25rem;
            background-color: #ffffff;
            color: #000000;
            text-shadow: none;
            cursor: pointer;
            border: none;
            transition: all 0.2s ease-in-out;
        }
        .btn:hover:not(:disabled) { background-color: #000000; color: #ffffff; box-shadow: 0 0 5px #ffffff; }
        .btn-secondary { background-color: transparent; color: #ffffff; border: 1px solid #ffffff; }
        .btn-secondary:hover { background-color: #ffffff; color: #000000; }
        .btn:disabled { background-color: #333; color: #888; cursor: not-allowed; opacity: 0.7; }
        .input-field, .select-field {
            background-color: #111;
            border: 1px solid #ffffff;
            color: #ffffff;
            padding: 0.75rem;
            width: 100%;
            font-family: 'VT323', monospace;
            text-transform: uppercase;
        }
        .input-field:focus, .select-field:focus { outline: none; box-shadow: 0 0 8px #ffffff; }
            .ascii-title {
                font-family: monospace;
                white-space: pre;
                text-align: center;
                line-height: 1.2;
                margin-bottom: 1rem;
                color: var(--color-header);
                text-shadow: var(--shadow-glow) var(--color-header);
                font-size: 0.9rem;
            }
            @media (min-width: 640px) {
                .ascii-title { font-size: 1.2rem; }
            }
            @media (min-width: 1024px) {
                .ascii-title { font-size: 1.6rem; }
            }
        .text-header { color: var(--color-header); text-shadow: var(--shadow-glow) var(--color-header); }
        .text-item-name { color: var(--color-accent); }
        .text-price { color: var(--color-price); font-weight: bold; }
        .text-dim { color: var(--color-dim); }
        .link-style { background: none; border: none; color: var(--color-accent); cursor: pointer; text-decoration: underline; }
        #dm-tools-btn, #logout-btn { background: none; border: none; color: white; font-size: 1.25rem; cursor: pointer; }
        #dm-tools-btn:hover, #logout-btn:hover { text-decoration: underline; }
        #exit-mode-btn { background: none; border: none; color: var(--color-header); font-size: 1.75rem; line-height: 1; cursor: pointer; padding: 0 0.5rem; }
        #exit-mode-btn:hover { color: white; }
        .subview-exit-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: none;
            border: none;
            color: var(--color-header);
            font-size: 1.75rem;
            line-height: 1;
            cursor: pointer;
            padding: 0.25rem;
        }
        .subview-exit-btn:hover { color: white; }
        .item-card { transition: transform 0.3s ease-out, box-shadow 0.3s ease-out, opacity 0.3s; touch-action: pan-y; }
        .item-card.sold-out { opacity: 0.5; }
        .item-card.swiping { transition: none; }
        @keyframes glow-success { 0% { box-shadow: 0 0 0px var(--color-header); } 50% { box-shadow: 0 0 15px var(--color-header); } 100% { box-shadow: 0 0 0px var(--color-header); } }
        .glow-once { animation: glow-success 0.7s ease-out; }
    </style>
</head>
<body class="p-4 sm:p-6 lg:p-8">

    <div id="toolbar" class="fixed top-0 left-0 right-0 bg-black p-4 z-50 flex justify-between items-center h-20">
        <div id="toolbar-title" class="text-2xl hidden text-header"></div>
        <div id="controls-container" class="relative ml-auto flex items-center gap-4">
             <button id="dm-tools-btn">DM Tools</button>
             <button id="exit-mode-btn" class="hidden">ⓧ</button>
             <button id="logout-btn" class="hidden">Logout</button>
        </div>
    </div>

    <div id="app-container" class="max-w-7xl my-8 py-8 mx-auto">
        <!-- Auth View -->
        <div id="auth-view">
             <div class="ascii-title">
██████╗ ███╗   ██╗██████╗     ██╗  ██╗██╗   ██╗██████╗ 
██╔══██╗████╗  ██║██╔══██╗    ██║  ██║██║   ██║██╔══██╗
██║  ██║██╔██╗ ██║██║  ██║    ███████║██║   ██║██████╔╝
██║  ██║██║╚██╗██║██║  ██║    ██╔══██║██║   ██║██╔══██╗
██████╔╝██║ ╚████║██████╔╝    ██║  ██║╚██████╔╝██████╔╝
╚═════╝ ╚═╝  ╚═══╝╚═════╝     ╚═╝  ╚═╝ ╚═════╝ ╚═════╝ 
                                                       
            </div>
            <div id="login-container" class="max-w-md mx-auto mb-8 cli-window text-center">
                <h2 class="text-2xl mb-4 text-header">> Welcome, Adventurer!</h2>
                <div class="flex flex-col sm:flex-row gap-2">
                    <input type="text" id="character-key-input" class="input-field flex-grow" placeholder="ENTER CHARACTER KEY" maxlength="6">
                    <button id="login-key-btn" class="btn">Enter</button>
                </div>
                <p class="my-4 text-dim">-- OR --</p>
                <button id="create-character-btn" class="btn w-full">Create New Character</button>
            </div>
        </div>

        <!-- Character Hub View -->
        <div id="character-hub-view" class="hidden"></div>
        <!-- DM Hub View -->
        <div id="dm-hub-view" class="hidden"></div>
        <!-- Create Shop View -->
        <div id="create-shop-view" class="hidden max-w-md mx-auto"></div>
        <!-- DM View -->
        <div id="dm-view" class="hidden"></div>
        <!-- Player View -->
        <div id="player-view" class="hidden"></div>
    </div>

    <!-- New Key Modal (Moved outside app-container) -->
    <div id="new-key-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-[100] p-4">
        <div class="cli-window w-full max-w-md text-center">
            <h2 class="text-2xl font-bold mb-4 text-header">> Your New Character Key!</h2>
            <p class="mb-4 text-dim">> This is your secret key. Write it down! It is the ONLY way to access your character again.</p>
            <div class="bg-gray-900 p-4 border-2 border-dashed border-header mb-6">
                <p id="new-key-display" class="text-4xl text-header tracking-widest"></p>
            </div>
            <button id="key-modal-continue-btn" class="btn w-full">Continue to Hub</button>
        </div>
    </div>

    <!-- Character Keys Modal -->
    <div id="keys-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-[100] p-4">
        <div class="cli-window w-full max-w-md text-center">
            <button id="keys-modal-close" class="subview-exit-btn">ⓧ</button>
            <h2 class="text-2xl font-bold mb-4 text-header">> All Character Keys</h2>
            <div id="keys-list" class="space-y-2"></div>
        </div>
    </div>
 
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, deleteDoc, getDoc, runTransaction, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyA4KsHgYxihH0fgsSET1kcnONHxtlInZIE",
          authDomain: "dnd-shop-app-c4f86.firebaseapp.com",
          projectId: "dnd-shop-app-c4f86",
          storageBucket: "dnd-shop-app-c4f86.appspot.com",
          messagingSenderId: "480358969004",
          appId: "1:480358969004:web:51e08541ec64dc4b4a7909",
          measurementId: "G-DWLMWMZTZ3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const itemCatalog = {
          "blacksmith": { "name": "Blacksmith/Armory", "items": [ { "name": "Studded Leather", "price": 45 }, { "name": "Chain Shirt", "price": 50 }, { "name": "Scale Mail", "price": 50 }, { "name": "Breastplate", "price": 400 }, { "name": "Half Plate", "price": 750 }, { "name": "Ring Mail", "price": 30 }, { "name": "Chain Mail", "price": 75 }, { "name": "Splint", "price": 200 }, { "name": "Plate", "price": 1500 }, { "name": "Shield", "price": 10 }, { "name": "Dagger", "price": 2 }, { "name": "Handaxe", "price": 5 }, { "name": "Javelin", "price": 0.5 }, { "name": "Light Hammer", "price": 2 }, { "name": "Mace", "price": 5 }, { "name": "Sickle", "price": 1 }, { "name": "Spear", "price": 1 }, { "name": "Battleaxe", "price": 10 }, { "name": "Flail", "price": 10 }, { "name": "Glaive", "price": 20 }, { "name": "Greataxe", "price": 30 }, { "name": "Greatsword", "price": 50 }, { "name": "Halberd", "price": 20 }, { "name": "Lance", "price": 10 }, { "name": "Longsword", "price": 15 }, { "name": "Maul", "price": 10 }, { "name": "Morningstar", "price": 15 }, { "name": "Pike", "price": 5 }, { "name": "Rapier", "price": 25 }, { "name": "Scimitar", "price": 25 }, { "name": "Shortsword", "price": 10 }, { "name": "Trident", "price": 5 }, { "name": "War Pick", "price": 5 }, { "name": "Warhammer", "price": 15 }, { "name": "Ball Bearings (bag of 1,000)", "price": 1 }, { "name": "Bell", "price": 1 }, { "name": "Block and Tackle", "price": 1 }, { "name": "Chain (10 feet)", "price": 5 }, { "name": "Crowbar", "price": 2 }, { "name": "Grappling Hook", "price": 2 }, { "name": "Hammer", "price": 1 }, { "name": "Sledgehammer", "price": 2 }, { "name": "Hunting Trap", "price": 5 }, { "name": "Lamp", "price": 0.5 }, { "name": "Lantern, Bullseye", "price": 10 }, { "name": "Lantern, Hooded", "price": 5 }, { "name": "Lock", "price": 10 }, { "name": "Manacles", "price": 2 }, { "name": "Mirror, Steel", "price": 5 }, { "name": "Pick, Miner's", "price": 2 }, { "name": "Piton", "price": 0.05 }, { "name": "Pot, Iron", "price": 2 }, { "name": "Spikes, Iron", "price": 1 }, { "name": "Whetstone", "price": 0.01 }, { "name": "Carpenter's Tools", "price": 8 }, { "name": "Mason's Tools", "price": 10 }, { "name": "Smith's Tools", "price": 20 }, { "name": "Tinker's Tools", "price": 50 }, { "name": "Horn", "price": 3 } ] },
          "fletcher": { "name": "Fletcher/Bowyer", "items": [ { "name": "Crossbow, Light", "price": 25 }, { "name": "Shortbow", "price": 25 }, { "name": "Crossbow, Hand", "price": 75 }, { "name": "Crossbow, Heavy", "price": 50 }, { "name": "Longbow", "price": 50 }, { "name": "Arrows (20)", "price": 1 }, { "name": "Crossbow Bolts (20)", "price": 1 }, { "name": "Case, Crossbow Bolt", "price": 1 }, { "name": "Quiver", "price": 1 } ] },
          "leathersmith": { "name": "Leathersmith/Tanner", "items": [ { "name": "Leather", "price": 10 }, { "name": "Studded Leather", "price": 45 }, { "name": "Hide", "price": 10 }, { "name": "Shield", "price": 10 }, { "name": "Sling", "price": 0.1 }, { "name": "Waterskin", "price": 0.2 }, { "name": "Cobbler's Tools", "price": 5 }, { "name": "Leatherworker's Tools", "price": 5 }, { "name": "Bagpipes", "price": 30 }, { "name": "Drum", "price": 6 } ] },
          "temple": { "name": "Temple/Priest", "items": [ { "name": "Alms Box", "price": 5 }, { "name": "Bell", "price": 1 }, { "name": "Blanket", "price": 0.5 }, { "name": "Book, Scripture", "price": 25 }, { "name": "Candle", "price": 0.01 }, { "name": "Case, Map or Scroll", "price": 1 }, { "name": "Censer", "price": 5 }, { "name": "Chalk (1 piece)", "price": 0.01 }, { "name": "Flask", "price": 0.02 }, { "name": "Healer's Kit", "price": 5 }, { "name": "Holy Symbol, Amulet", "price": 5 }, { "name": "Holy Symbol, Emblem", "price": 5 }, { "name": "Holy Symbol, Reliquary", "price": 5 }, { "name": "Holy Water (flask)", "price": 25 }, { "name": "Incense (1 block)", "price": 0.01 }, { "name": "Ink (1 ounce bottle)", "price": 10 }, { "name": "Ink Pen", "price": 0.02 }, { "name": "Lamp", "price": 0.5 }, { "name": "Lantern, Hooded", "price": 5 }, { "name": "Oil (flask)", "price": 0.1 }, { "name": "Paper (one sheet)", "price": 0.2 }, { "name": "Parchment (one sheet)", "price": 0.1 }, { "name": "Perfume (vial)", "price": 5 }, { "name": "Potion of Healing", "price": 50 }, { "name": "Rations (1 day)", "price": 0.5 }, { "name": "Torch", "price": 0.01 }, { "name": "Vial", "price": 1 }, { "name": "Waterskin", "price": 0.2 }, { "name": "Calligrapher's Supplies", "price": 10 }, { "name": "Herbalism Kit", "price": 5 }, { "name": "Flute", "price": 2 }, { "name": "Lyre", "price": 30 }, { "name": "Horn", "price": 3 }, { "name": "Cure Wounds (lvl 1)", "price": 10, "type": "service" }, { "name": "Gentle Repose (lvl 2)", "price": 50, "type": "service" }, { "name": "Lesser Restoration (lvl 2)", "price": 50, "type": "service" }, { "name": "Remove Curse (lvl 3)", "price": 100, "type": "service" }, { "name": "Revivify (lvl 3)", "price": 400, "type": "service" }, { "name": "Raise Dead (lvl 5)", "price": 1000, "type": "service" } ] },
          "general_store": { "name": "General Store", "items": [ { "name": "Abacus", "price": 2 }, { "name": "Barrel", "price": 2 }, { "name": "Blanket", "price": 0.5 }, { "name": "Bottle, glass", "price": 2 }, { "name": "Bucket", "price": 0.05 }, { "name": "Candle", "price": 0.01 }, { "name": "Chest", "price": 5 }, { "name": "Clothes, Common", "price": 0.5 }, { "name": "Clothes, Fine", "price": 15 }, { "name": "Flask or Tankard", "price": 0.02 }, { "name": "Hammer", "price": 1 }, { "name": "Ink (1 ounce bottle)", "price": 10 }, { "name": "Ink Pen", "price": 0.02 }, { "name": "Jug or Pitcher", "price": 0.02 }, { "name": "Ladder (10-foot)", "price": 0.1 }, { "name": "Lantern, Hooded", "price": 5 }, { "name": "Lamp", "price": 0.5 }, { "name": "Lock", "price": 10 }, { "name": "Mess Kit", "price": 0.2 }, { "name": "Mirror, Steel", "price": 5 }, { "name": "Paper (one sheet)", "price": 0.2 }, { "name": "Parchment (one sheet)", "price": 0.1 }, { "name": "Pick, Miner's", "price": 2 }, { "name": "Pot, Iron", "price": 2 }, { "name": "Pouch", "price": 0.5 }, { "name": "Rope, Hempen (50 feet)", "price": 1 }, { "name": "Rope, Silk (50 feet)", "price": 10 }, { "name": "Sack", "price": 0.01 }, { "name": "Scale, Merchant's", "price": 5 }, { "name": "Shovel", "price": 2 }, { "name": "Signet Ring", "price": 5 }, { "name": "Soap", "price": 0.02 }, { "name": "Vial", "price": 1 }, { "name": "Carpenter's Tools", "price": 15 }, { "name": "Cobbler's Tools", "price": 25 }, { "name": "Cook's Utensils", "price": 50 }, { "name": "Glassblower's Tools", "price": 30 }, { "name": "Leatherworker's Tools", "price": 5 }, { "name": "Mason's Tools", "price": 10 }, { "name": "Potter's Tools", "price": 10 }, { "name": "Smith's Tools", "price": 20 }, { "name": "Weaver's Tools", "price": 1 }, { "name": "Woodcarver's Tools", "price": 1 } ] },
          "adventuring_supplies": { "name": "Adventuring Supplies", "items": [ { "name": "Padded Armor", "price": 5 }, { "name": "Leather Armor", "price": 10 }, { "name": "Studded Leather", "price": 45 }, { "name": "Hide Armor", "price": 10 }, { "name": "Club", "price": 0.1 }, { "name": "Dagger", "price": 2 }, { "name": "Greatclub", "price": 0.2 }, { "name": "Handaxe", "price": 5 }, { "name": "Light Hammer", "price": 2 }, { "name": "Quarterstaff", "price": 0.2 }, { "name": "Crossbow, Light", "price": 25 }, { "name": "Dart", "price": 0.05 }, { "name": "Shortbow", "price": 25 }, { "name": "Sling", "price": 0.1 }, { "name": "Whip", "price": 2 }, { "name": "Blowgun", "price": 10 }, { "name": "Crossbow, Hand", "price": 75 }, { "name": "Crossbow, Heavy", "price": 50 }, { "name": "Longbow", "price": 50 }, { "name": "Arrows (20)", "price": 1 }, { "name": "Blowgun Needles (50)", "price": 1 }, { "name": "Crossbow Bolts (20)", "price": 1 }, { "name": "Sling Bullets (20)", "price": 0.04 }, { "name": "Backpack", "price": 2 }, { "name": "Bedroll", "price": 1 }, { "name": "Blanket", "price": 0.5 }, { "name": "Block and Tackle", "price": 1 }, { "name": "Bottle, glass", "price": 2 }, { "name": "Candle", "price": 0.01 }, { "name": "Case, Crossbow Bolt", "price": 1 }, { "name": "Case, Map or Scroll", "price": 1 }, { "name": "Chain (10 feet)", "price": 5 }, { "name": "Chest", "price": 5 }, { "name": "Climber's Kit", "price": 25 }, { "name": "Clothes, Traveler's", "price": 2 }, { "name": "Crowbar", "price": 2 }, { "name": "Flask or Tankard", "price": 0.02 }, { "name": "Grappling Hook", "price": 2 }, { "name": "Hammer", "price": 1 }, { "name": "Healer's Kit", "price": 5 }, { "name": "Hourglass", "price": 25 }, { "name": "Hunting Trap", "price": 5 }, { "name": "Ink (1 ounce bottle)", "price": 10 }, { "name": "Ink Pen", "price": 0.02 }, { "name": "Jug or Pitcher", "price": 0.02 }, { "name": "Ladder (10-foot)", "price": 0.1 }, { "name": "Lantern, Bullseye", "price": 10 }, { "name": "Lantern, Hooded", "price": 5 }, { "name": "Lock", "price": 10 }, { "name": "Mess Kit", "price": 0.2 }, { "name": "Mirror, Steel", "price": 5 }, { "name": "Paper (one sheet)", "price": 0.2 }, { "name": "Parchment (one sheet)", "price": 0.1 }, { "name": "Pick, Miner's", "price": 2 }, { "name": "Piton", "price": 0.05 }, { "name": "Pole (10-foot)", "price": 0.05 }, { "name": "Pot, Iron", "price": 2 }, { "name": "Pouch", "price": 0.5 }, { "name": "Quiver", "price": 1 }, { "name": "Rations (1 day)", "price": 0.5 }, { "name": "Rope, Hempen (50 feet)", "price": 1 }, { "name": "Rope, Silk (50 feet)", "price": 10 }, { "name": "Sack", "price": 0.01 }, { "name": "Shovel", "price": 2 }, { "name": "Signal Whistle", "price": 5 }, { "name": "Signet Ring", "price": 5 }, { "name": "Spyglass", "price": 1000 }, { "name": "Tent, Two-person", "price": 2 }, { "name": "Tinderbox", "price": 0.5 }, { "name": "Torch", "price": 0.01 }, { "name": "Vial", "price": 1 }, { "name": "Waterskin", "price": 0.2 }, { "name": "Cartographer's Tools", "price": 15 }, { "name": "Jeweler's Tools", "price": 25 }, { "name": "Tinker's Tools", "price": 50 }, { "name": "Herbalism Kit", "price": 5 }, { "name": "Navigator's Tools", "price": 25 } ] },
          "arcane_shop": { "name": "Arcane Shop", "items": [ { "name": "Crystal", "price": 10 }, { "name": "Orb", "price": 20 }, { "name": "Rod", "price": 10 }, { "name": "Staff", "price": 5 }, { "name": "Wand", "price": 10 }, { "name": "Component Pouch", "price": 25 }, { "name": "Potion of Healing", "price": 50 }, { "name": "Spellbook", "price": 50 } ] },
          "thieves_guild": { "name": "Thieves' Guild", "items": [ { "name": "Acid (vial)", "price": 25 }, { "name": "Antitoxin (vial)", "price": 50 }, { "name": "Caltrops (bag of 20)", "price": 1 }, { "name": "Clothes, Costume", "price": 5 }, { "name": "Manacles", "price": 2 }, { "name": "Oil (flask)", "price": 0.1 }, { "name": "Poison, Basic (vial)", "price": 100 }, { "name": "Ram, Portable", "price": 4 }, { "name": "Spikes, Iron (10)", "price": 1 }, { "name": "Disguise Kit", "price": 25 }, { "name": "Forgery Kit", "price": 15 }, { "name": "Dice Set", "price": 0.1 }, { "name": "Playing Card Set", "price": 0.5 }, { "name": "Poisoner's Kit", "price": 50 }, { "name": "Thieves' Tools", "price": 25 } ] },
          "potion_shop": { "name": "Potion Shop", "items": [ { "name": "Acid (vial)", "price": 25 }, { "name": "Alchemist's Fire (flask)", "price": 50 }, { "name": "Antitoxin (vial)", "price": 50 }, { "name": "Bottle, glass", "price": 2 }, { "name": "Component Pouch", "price": 25 }, { "name": "Flask", "price": 0.02 }, { "name": "Healer's Kit", "price": 5 }, { "name": "Ink (1 ounce bottle)", "price": 10 }, { "name": "Jug", "price": 0.02 }, { "name": "Oil (flask)", "price": 0.1 }, { "name": "Perfume (vial)", "price": 5 }, { "name": "Poison, Basic (vial)", "price": 100 }, { "name": "Potion of Healing", "price": 50 }, { "name": "Vial", "price": 1 }, { "name": "Alchemist's Supplies", "price": 50 }, { "name": "Brewer's Supplies", "price": 20 }, { "name": "Cook's Utensils", "price": 1 }, { "name": "Poisoner's Kit", "price": 50 }, { "name": "Potion (Common)", "price": 50 }, { "name": "Potion (Uncommon)", "price": 250 }, { "name": "Potion (Rare)", "price": 2500 } ] }
        };

        let shopUnsubscribe = null;
        let playerUnsubscribe = null;

        let state = {
            isDM: false,
            inShop: false,
            characterKey: null,
            playerData: null,
            shopId: null,
            shopData: null,
            activeShops: [],
        };

        // DOM Elements
        const allViews = document.querySelectorAll('#app-container > div');
        const authView = document.getElementById('auth-view');
        const characterHubView = document.getElementById('character-hub-view');
        const dmHubView = document.getElementById('dm-hub-view');
        const createShopView = document.getElementById('create-shop-view');
        const dmView = document.getElementById('dm-view');
        const playerView = document.getElementById('player-view');
        const toolbarTitle = document.getElementById('toolbar-title');
        const controlsContainer = document.getElementById('controls-container');
        const dmToolsBtn = document.getElementById('dm-tools-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const exitModeBtn = document.getElementById('exit-mode-btn');
        const newKeyModal = document.getElementById('new-key-modal');
        const keysModal = document.getElementById('keys-modal');

        // --- Initialization ---
        function main() {
            // Auth
            document.getElementById('login-key-btn').addEventListener('click', handleKeyLogin);
            document.getElementById('create-character-btn').addEventListener('click', handleCreateCharacter);

            document.getElementById('key-modal-continue-btn').addEventListener('click', () => {
                newKeyModal.classList.add('hidden');
                if (state.characterKey) {
                    listenToPlayerData(state.characterKey);
                }
            });

            // DM
            dmToolsBtn.addEventListener('click', enterDMHub);
            logoutBtn.addEventListener('click', logout);
            exitModeBtn.addEventListener('click', exitCurrentMode);
            keysModal.addEventListener('click', (e) => {
                if (e.target === keysModal || e.target.id === 'keys-modal-close') {
                    keysModal.classList.add('hidden');
                }
            });

            // Check for saved key
            const savedKey = localStorage.getItem('dndShopCharacterKey');
            if (savedKey) {
                loginWithKey(savedKey);
            }
            listenToActiveShops();
            render();
        }

        function handleEditInventory() {
            const summary = state.playerData.inventory.reduce((acc, item) => {
                acc[item.name] = (acc[item.name] || 0) + 1;
                return acc;
            }, {});
            const itemName = prompt('Enter the item name to remove:');
            if (!itemName) return;
            const available = summary[itemName];
            if (!available) { alert('Item not found.'); return; }
            const qty = parseInt(prompt(`Remove how many? (1-${available})`), 10);
            if (!qty || qty <= 0 || qty > available) return;
            if (!confirm(`Remove ${qty} ${itemName}? This cannot be undone.`)) return;
            let remaining = qty;
            const newInv = state.playerData.inventory.filter(it => {
                if (it.name === itemName && remaining > 0) { remaining--; return false; }
                return true;
            });
            state.playerData.inventory = newInv;
            updateDoc(doc(db, 'characters', state.characterKey), { inventory: newInv });
            renderCharacterHub();
        }

        // --- Auth & Character Functions ---
        async function handleKeyLogin() {
            const key = document.getElementById('character-key-input').value.toUpperCase();
            if (key.length !== 6) { alert("Please enter a valid 6-character key."); return; }
            await loginWithKey(key);
        }

        async function loginWithKey(key) {
            const playerDocRef = doc(db, 'characters', key);
            const docSnap = await getDoc(playerDocRef);
            if (docSnap.exists()) {
                state.characterKey = key;
                localStorage.setItem('dndShopCharacterKey', key);
                listenToPlayerData(key);
            } else {
                alert("Character key not found.");
            }
        }

        async function handleCreateCharacter() {
            const key = Math.random().toString(36).substring(2, 8).toUpperCase();
            const playerDocRef = doc(db, 'characters', key);
            
            try {
                await setDoc(playerDocRef, {
                    name: "Adventurer",
                    gold: 50,
                    inventory: []
                });
                document.getElementById('new-key-display').textContent = key;
                newKeyModal.classList.remove('hidden');
                state.characterKey = key;
                localStorage.setItem('dndShopCharacterKey', key);
            } catch (error) {
                console.error("Error creating character:", error);
                alert("Could not create character. Please try again.");
            }
        }

        function listenToPlayerData(key) {
            if (playerUnsubscribe) playerUnsubscribe();
            const playerDocRef = doc(db, 'characters', key);
            playerUnsubscribe = onSnapshot(playerDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    state.playerData = docSnap.data();
                } else {
                    alert("Character data lost or deleted.");
                    logout();
                }
                render();
            });
        }

        let activeShopsUnsubscribe = null;
        function listenToActiveShops() {
            if (activeShopsUnsubscribe) activeShopsUnsubscribe();
            const q = query(collection(db, 'shops'), where('active', '==', true));
            activeShopsUnsubscribe = onSnapshot(q, (snapshot) => {
                state.activeShops = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (!state.inShop && !state.isDM) render();
            });
        }

        function logout() {
            if (playerUnsubscribe) playerUnsubscribe();
            localStorage.removeItem('dndShopCharacterKey');
            state.characterKey = null;
            state.playerData = null;
            exitCurrentMode();
        }

        function enterDMHub() {
            if (shopUnsubscribe) { shopUnsubscribe(); shopUnsubscribe = null; }
            state.isDM = true;
            state.inShop = false;
            state.shopId = null;
            state.shopData = null;
            render();
        }

        // --- Core App Logic ---
        function exitSubView() {
            createShopView.classList.add('hidden');
            render(); // This will show the correct main view (auth or hub)
        }

        function showCreateShopView() {
            authView.classList.add('hidden');
            characterHubView.classList.add('hidden');
            dmHubView.classList.add('hidden');
            createShopView.classList.remove('hidden');
            createShopView.innerHTML = `
                <div class="cli-window">
                    <button id="exit-create-shop-btn" class="subview-exit-btn">ⓧ</button>
                    <h2 class="text-2xl mb-4 text-header">> Create a New Shop</h2>
                    <div class="space-y-4">
                        <div><label for="shop-type-select" class="block mb-1">> Shop Type</label><select id="shop-type-select" class="select-field">${Object.keys(itemCatalog).map(key => `<option value="${key}">${itemCatalog[key].name}</option>`).join('')}</select></div>
                        <div><label for="shop-size-select" class="block mb-1">> Shop Size</label><select id="shop-size-select" class="select-field">${['Small', 'Urban', 'Specialty'].map(size => `<option value="${size.toLowerCase()}">${size}</option>`).join('')}</select></div>
                        <button id="generate-shop-btn" class="btn w-full">Go</button>
                    </div>
                </div>`;
            document.getElementById('generate-shop-btn').addEventListener('click', handleGenerateShop);
            document.getElementById('exit-create-shop-btn').addEventListener('click', exitSubView);
        }
        
        async function openKeysModal() {
            keysModal.classList.remove('hidden');
            const keysList = document.getElementById('keys-list');
            keysList.innerHTML = 'Loading...';

            try {
                const querySnapshot = await getDocs(collection(db, "characters"));
                keysList.innerHTML = querySnapshot.docs.map(doc => {
                    const data = doc.data();
                    return `<p class="key-item cursor-pointer" data-key="${doc.id}"><span class="text-item-name">${data.name}</span>: <span class="text-header">${doc.id}</span></p>`;
                }).join('');
                document.querySelectorAll('.key-item').forEach(el => {
                    el.addEventListener('click', () => navigator.clipboard.writeText(el.dataset.key));
                });
            } catch (error) {
                keysList.innerHTML = `<p class="text-red-500">Could not load keys.</p>`;
                console.error("Error fetching keys:", error);
            }
        }

        function handleGenerateShop() {
            const shopKey = document.getElementById('shop-type-select').value;
            const shopSize = document.getElementById('shop-size-select').value;
            createShopView.classList.add('hidden');
            createSession(shopKey, shopSize);
        }

        function exitCurrentMode() {
            if (shopUnsubscribe) { shopUnsubscribe(); shopUnsubscribe = null; }
            state.isDM = false;
            state.inShop = false;
            state.shopId = null;
            state.shopData = null;
            render();
        }

        function generateShopkeeper() {
            const names = [
                'Aelar',
                'Borin',
                'Cedric',
                'Daria',
                'Eldon',
                'Fira',
                'Garron',
                'Hilda'
            ];
            const personalities = [
                'cheerful and talkative',
                'gruff but fair',
                'mysterious and quiet',
                'greedy with a sharp eye for coin',
                'kind-hearted and generous',
                'sarcastic with a dark sense of humor',
                'nervous and jumpy',
                'wise and patient'
            ];
            const name = names[Math.floor(Math.random() * names.length)];
            const description = personalities[Math.floor(Math.random() * personalities.length)];
            const gold = Math.floor(Math.random() * 1501) + 500;
            return { name, description, gold };
        }

        function generateShopName() {
            const adjectives = ['Rusty','Golden','Wandering','Lucky','Silver','Hidden','Mystic','Brave','Silent','Clever'];
            const nouns = ['Anvil','Dragon','Goblet','Merchant','Griffin','Sword','Scroll','Shield','Lantern','Dagger'];
            const adj = adjectives[Math.floor(Math.random() * adjectives.length)];
            const noun = nouns[Math.floor(Math.random() * nouns.length)];
            return `The ${adj} ${noun}`;
        }

        async function createSession(shopKey, shopSize) {
            state.isDM = true;
            state.inShop = true;
            
            const shopTemplate = itemCatalog[shopKey];
            const fullInventory = shopTemplate.items;
            let randomInventory = [];
            if (shopSize === 'small') {
                const shuffled = fullInventory.sort(() => 0.5 - Math.random());
                randomInventory = shuffled.slice(0, Math.floor(Math.random() * 8) + 5);
            } else if (shopSize === 'urban') {
                const shuffled = fullInventory.sort(() => 0.5 - Math.random());
                const min = Math.ceil(fullInventory.length * 0.4);
                const max = Math.floor(fullInventory.length * 0.8);
                randomInventory = shuffled.slice(0, Math.floor(Math.random() * (max - min + 1)) + min);
            } else {
                const sorted = [...fullInventory].sort((a, b) => b.price - a.price);
                randomInventory = sorted.slice(0, Math.floor(Math.random() * 5) + 3);
            }

            const finalInventory = randomInventory.map(item => ({
                ...item,
                quantity: Math.floor(Math.random() * 5) + 1,
                id: `item-${Math.random().toString(36).substr(2, 9)}`
            }));

            const newSessionRef = doc(collection(db, 'shops'));
            state.shopId = newSessionRef.id;
            const initialShopData = {
                shopName: generateShopName(),
                shopType: shopTemplate.name,
                shopkeeper: generateShopkeeper(),
                inventory: finalInventory,
                carts: {},
                priceModifier: 0,
                active: true,
            };

            state.shopData = initialShopData;

            try {
                await setDoc(newSessionRef, initialShopData);
                listenToShopChanges(state.shopId);
                render();
            } catch (error) {
                console.error("Error creating session:", error);
                alert("Error creating session.");
                exitCurrentMode();
            }
        }
        
        async function joinShop(shopId) {
            const shopDocRef = doc(db, 'shops', shopId);
            const docSnap = await getDoc(shopDocRef);
            if (docSnap.exists() && docSnap.data().active) {
                state.shopId = shopId;
                state.inShop = true;
                listenToShopChanges(shopId);
            } else {
                alert("Shop not found or inactive.");
            }
        }

        function listenToShopChanges(shopId) {
            if (shopUnsubscribe) shopUnsubscribe(); 
            const shopDocRef = doc(db, 'shops', shopId);
            shopUnsubscribe = onSnapshot(shopDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    state.shopData = docSnap.data();
                    render();
                } else {
                    alert("Shop session has ended.");
                    exitCurrentMode();
                }
            }, (error) => {
                console.error("Firestore listener error:", error);
                alert("Connection to shop lost.");
                exitCurrentMode();
            });
        }
        
        // --- RENDER FUNCTIONS ---
        function render() {

            const loggedIn = !!state.characterKey;
            const inShop = state.inShop;

            allViews.forEach(v => v.classList.add('hidden'));

            controlsContainer.classList.remove('hidden');

            const showDmTools = !state.isDM;
            if (state.isDM || inShop) {
                exitModeBtn.classList.remove('hidden');
                toolbarTitle.classList.remove('hidden');
                toolbarTitle.textContent = state.isDM ? (inShop ? '> DM Mode' : '> DM Hub') : '> Player Mode';
            } else {
                exitModeBtn.classList.add('hidden');
                toolbarTitle.classList.add('hidden');
            }
            if (showDmTools) {
                dmToolsBtn.classList.remove('hidden');
            } else {
                dmToolsBtn.classList.add('hidden');
            }

            if (loggedIn) {
                logoutBtn.classList.remove('hidden');
            } else {
                logoutBtn.classList.add('hidden');
            }

            if (!loggedIn && !state.isDM) {
                authView.classList.remove('hidden');
            } else if (!inShop) {
                if (state.isDM) {
                    dmHubView.classList.remove('hidden');
                    renderDMHub();
                } else {
                    characterHubView.classList.remove('hidden');
                    renderCharacterHub();
                }
            } else if (state.isDM) {
                dmView.classList.remove('hidden');
                renderDMView();
            } else {
                playerView.classList.remove('hidden');
                renderPlayerView();
            }
        }

        function renderCharacterHub() {
            const player = state.playerData;
            if (!player) {
                characterHubView.innerHTML = `<div class="cli-window text-center"><p class="text-header">Loading Character...</p></div>`;
                return;
            }
            const inventorySummary = player.inventory.reduce((acc, item) => {
                acc[item.name] = (acc[item.name] || 0) + 1;
                return acc;
            }, {});

            characterHubView.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="cli-window">
                        <h2 class="text-2xl text-header mb-2">> ${player.name}</h2>
                        <p class="text-dim">Key: <span class="text-header">${state.characterKey}</span></p>
                        <p class="text-2xl text-price mt-2">${player.gold} GP</p>
                        <a href="character.html" class="btn mt-4 w-full">Character Sheet</a>
                    </div>
                    <div class="cli-window">
                        <h3 class="text-2xl text-header mb-4">> Inventory</h3>
                        <div class="space-y-2 max-h-60 overflow-y-auto">${Object.keys(inventorySummary).length === 0 ? '<p class="text-dim">Empty.</p>' : Object.entries(inventorySummary).map(([name, count]) => `<div><span class="text-item-name">${name}</span> <span class="text-dim">(x${count})</span></div>`).join('')}</div>
                        <button id="edit-inventory-btn" class="btn btn-secondary w-full mt-4">Edit Inventory</button>
                    </div>
                </div>
                <div class="mt-8 cli-window max-w-md mx-auto">
                    <h2 class="text-2xl mb-4 text-header">> Active Shops</h2>
                    ${state.activeShops.length === 0
                        ? '<p class="text-dim">No active shops.</p>'
                        : state.activeShops.map(s => `
                            <div class="flex justify-between items-center mb-2">
                                <span><span class="text-item-name">${s.shopName || s.shopType}</span></span>
                                <button class="btn join-shop-btn" data-shop-id="${s.id}">Enter</button>
                            </div>
                        `).join('')}
                </div>
            `;
            document.querySelectorAll('.join-shop-btn').forEach(btn => {
                btn.addEventListener('click', e => joinShop(e.target.dataset.shopId));
            });
            document.getElementById('edit-inventory-btn')?.addEventListener('click', handleEditInventory);
        }

        function renderDMHub() {
            dmHubView.innerHTML = `
                <div class="cli-window max-w-md mx-auto">
                    <h2 class="text-2xl mb-4 text-header">> DM Tools</h2>
                    <div class="space-y-2">
                        <button id="dm-create-shop-btn" class="btn w-full">Create New Shop</button>
                        <button id="dm-view-keys-btn" class="btn w-full">View Character Keys</button>
                    </div>
                </div>
                <div class="mt-8 cli-window max-w-md mx-auto">
                    <h2 class="text-2xl mb-4 text-header">> Active Shops</h2>
                    ${state.activeShops.length === 0
                        ? '<p class="text-dim">No active shops.</p>'
                        : state.activeShops.map(s => `
                            <div class="flex justify-between items-center mb-2">
                                <span><span class="text-item-name">${s.shopName || s.shopType}</span></span>
                                <div class="flex gap-2">
                                    <button class="btn dm-enter-shop-btn" data-shop-id="${s.id}">Open</button>
                                    <button class="btn btn-secondary dm-delete-shop-btn" data-shop-id="${s.id}">Delete</button>
                                </div>
                            </div>
                        `).join('')}
                </div>
            `;
            document.getElementById('dm-create-shop-btn').addEventListener('click', showCreateShopView);
            document.getElementById('dm-view-keys-btn').addEventListener('click', openKeysModal);
            document.querySelectorAll('.dm-enter-shop-btn').forEach(btn => {
                btn.addEventListener('click', e => joinShop(e.target.dataset.shopId));
            });
            document.querySelectorAll('.dm-delete-shop-btn').forEach(btn => btn.addEventListener('click', handleDMDeleteShop));
        }

        async function handleDMDeleteShop(e) {
            const shopId = e.target.dataset.shopId;
            if (!confirm('Delete this shop? This cannot be undone.')) return;
            await deleteDoc(doc(db, 'shops', shopId));
            state.activeShops = state.activeShops.filter(s => s.id !== shopId);
            renderDMHub();
        }
        
        function getModifiedPrice(basePrice) {
            const modifier = state.shopData?.priceModifier || 0;
            const modified = basePrice * (1 + modifier / 100);
            return Math.round(modified * 100) / 100;
        }

        function renderDMView() {
            const { shopkeeper, inventory, carts, shopType, priceModifier, shopName } = state.shopData;
            dmView.innerHTML = `<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 text-lg">
                <div class="lg:col-span-1 flex flex-col gap-6">
                    <div class="cli-window">
                        <h2 class="text-2xl mb-4 text-header">> DM Controls</h2>
                        <p class="mb-1">> Shop: <span class="text-item-name">${shopName}</span></p>
                        <p class="mb-1">> Type: ${shopType}</p>
                        <div class="mt-4">
                            <label class="block mb-1">> Price Modifier: <span id="price-modifier-label">${priceModifier}%</span></label>
                            <div class="grid grid-cols-3 gap-2">
                                ${[-50,-25,-15,15,25,50].map(v => `<button class="btn btn-secondary price-mod-btn" data-value="${v}">${v>0?`+${v}`:v}%</button>`).join('')}
                            </div>
                        </div>
                        <div class="mt-4">
                            <label class="block mb-1">> Status: <span class="text-item-name">${state.shopData.active ? 'Active' : 'Inactive'}</span></label>
                            <button id="toggle-active-btn" class="btn btn-secondary w-full">${state.shopData.active ? 'Set Inactive' : 'Set Active'}</button>
                        </div>
                        <div class="mt-4">
                            <button id="delete-shop-btn" class="btn btn-secondary w-full text-red-500 border-red-500">Delete Shop</button>
                        </div>
                    </div>
                    <div class="cli-window"><h3 class="text-2xl mb-4 text-header">> Shopkeeper</h3><p>> Name: <span class="text-item-name">${shopkeeper.name}</span></p><p class="text-dim">> Personality: ${shopkeeper.description||'...'}</p><div class="flex items-center gap-2 mt-2"><p class="whitespace-nowrap">> Gold:</p><input type="number" id="shop-gold-input" value="${shopkeeper.gold}" class="input-field text-price"></div></div>
                </div>
                <div class="lg:col-span-1 flex flex-col gap-6">
                    <div class="cli-window">
                        <h3 class="text-2xl mb-4 text-header">> Shop Inventory</h3>
                        <div id="dm-inventory-list" class="space-y-4">${inventory.map((item,index)=>`<div class="item-card border border-white/50 p-3 space-y-2" data-index="${index}"><div class="flex justify-between items-center"><span class="text-item-name">${item.name}</span><button class="text-red-500 hover:text-red-400 dm-remove-item-btn" data-index="${index}">[X]</button></div><div class="flex items-center gap-2"><label class="text-dim">Qty:</label><input type="number" min="0" class="input-field dm-qty-input w-16" data-index="${index}" value="${item.quantity}"><label class="text-dim">Price:</label><input type="number" min="0" step="0.01" class="input-field dm-price-input w-24" data-index="${index}" value="${item.price}"></div></div>`).join('')}</div>
                        <div class="mt-4">
                            <h4 class="text-xl mb-2 text-header">> Add Custom Item</h4>
                            <input id="custom-item-name" class="input-field mb-2" placeholder="Item Name">
                            <div class="flex gap-2 mb-2">
                                <input id="custom-item-price" type="number" class="input-field flex-1" placeholder="Price">
                                <input id="custom-item-qty" type="number" class="input-field flex-1" placeholder="Qty">
                            </div>
                            <button id="add-custom-item-btn" class="btn w-full">Add Item</button>
                        </div>
                    </div>
                </div>
                <div class="lg:col-span-1 flex flex-col gap-6">
                    <div class="cli-window"><h3 class="text-2xl mb-4 text-header">> Player Carts</h3><div id="player-carts-list" class="space-y-4">${Object.keys(carts || {}).length===0?'<p class="text-dim">No active carts.</p>':Object.entries(carts).map(([playerId,cartData])=>`<div><h4 class="text-xl text-header">${cartData.playerName}</h4>${cartData.items.length > 0 ? `<ul class="pl-4 list-disc list-inside">${cartData.items.map(item=>`<li><span class="text-item-name">${item.name}</span></li>`).join('')}</ul><p class="mt-2 text-right">> Cart Total: <span class="text-price">${cartData.items.reduce((sum,item)=>sum+getModifiedPrice(item.price),0)} GP</span></p><button class="btn w-full mt-3 checkout-btn" data-player-id="${playerId}">Checkout</button>` : ''}</div>`).join('')}</div></div>
                </div>
            </div>`;
            attachDMListeners();
        }


        function renderPlayerView() {
            const { shopkeeper, inventory, carts, shopType, shopName } = state.shopData;
            const playerCart = carts[state.characterKey] || { items: [] };
            const cartTotal = playerCart.items.reduce((sum, item) => sum + getModifiedPrice(item.price), 0);
            playerView.innerHTML = `<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 text-lg">
                <div class="lg:col-span-2">
                    <div class="cli-window mb-6"><h1 class="text-3xl text-header">${shopName}</h1><p class="text-xl text-dim">(${shopType})</p><p class="text-xl">> Shopkeeper: <span class="text-item-name">${shopkeeper.name}</span></p><p class="text-xl text-dim">> ${shopkeeper.description||'...'}</p></div>
                    <div class="cli-window"><h2 class="text-2xl mb-4 text-header">> Items for Sale</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-4">${inventory.map(item=>`<div class="item-card ${item.quantity === 0 ? 'sold-out' : ''} border border-white/50 p-3 flex flex-col justify-between" data-item-id="${item.id}"><p class="text-xl"><span class="text-item-name">${item.name}</span> <span class="text-dim">(x${item.quantity})</span></p><p class="text-price">${item.quantity > 0 ? `${getModifiedPrice(item.price)} GP` : 'SOLD OUT'}</p><div class="mt-auto pt-2 flex justify-end items-center gap-2">${item.quantity > 0 ? `<button class="btn add-to-cart-btn" data-item-id="${item.id}">Add</button>`: ''}</div></div>`).join('')}</div></div>
                </div>
                <div class="lg:col-span-1">
                    <div class="cli-window sticky top-24"><h2 class="text-2xl mb-4 text-header">> ${state.playerData.name}'s Purse</h2><p class="text-2xl text-price">${state.playerData.gold} GP</p><hr class="border-white/50 my-4"><h2 class="text-2xl mb-4 text-header">> Your Cart</h2><div id="player-cart-list" class="space-y-2 mb-4 min-h-[50px]">${playerCart.items.length===0?'<p class="text-dim">Your cart is empty.</p>':playerCart.items.map((item,index)=>`<div class="flex justify-between items-center"><span>- <span class="text-item-name">${item.name}</span></span><button class="text-red-500 hover:text-red-400 remove-from-cart-btn" data-index="${index}">[X]</button></div>`).join('')}</div><hr class="border-white/50 my-4"><p class="text-xl text-right">> Total: <span class="text-price">${cartTotal} GP</span></p></div>
                </div>
            </div>`;
            attachPlayerListeners();
        }
        
        async function handleCheckout(e) {
            const playerId = e.target.dataset.playerId;
            const shopDocRef = doc(db, "shops", state.shopId);
            const playerDocRef = doc(db, "characters", playerId);

            try {
                await runTransaction(db, async (transaction) => {
                    const shopDoc = await transaction.get(shopDocRef);
                    const playerDoc = await transaction.get(playerDocRef);
                    if (!shopDoc.exists() || !playerDoc.exists()) { throw "Document not found!"; }

                    const shopData = shopDoc.data();
                    const playerData = playerDoc.data();
                    const cart = shopData.carts[playerId];
                    if (!cart || cart.items.length === 0) { return; }

                    const totalCost = cart.items.reduce((sum, item) => sum + getModifiedPrice(item.price), 0);
                    if (playerData.gold < totalCost) { throw `${playerData.name} doesn't have enough gold!`; }

                    const newShopInventory = [...shopData.inventory];
                    const purchasedItems = [];

                    for (const cartItem of cart.items) {
                        const invItem = newShopInventory.find(i => i.id === cartItem.id);
                        if (invItem && invItem.quantity > 0) {
                            invItem.quantity -= 1;
                            const { quantity, ...itemToStore } = invItem;
                            purchasedItems.push(itemToStore);
                        } else {
                            throw `Item ${cartItem.name} is sold out!`;
                        }
                    }
                    
                    transaction.update(shopDocRef, {
                        inventory: newShopInventory,
                        "shopkeeper.gold": shopData.shopkeeper.gold + totalCost,
                        [`carts.${playerId}`]: { items: [] }
                    });

                    transaction.update(playerDocRef, {
                        gold: playerData.gold - totalCost,
                        inventory: [...playerData.inventory, ...purchasedItems]
                    });
                });
            } catch (error) {
                console.error("Transaction failed: ", error);
                alert(`Checkout failed: ${error}`);
            }
        }

        function handleAddToCart(itemId) {
            const itemToAdd = state.shopData.inventory.find(item => item.id === itemId);
            if (!itemToAdd || itemToAdd.quantity <= 0) return;

            const playerCart = state.shopData.carts[state.characterKey] || { items: [] };
            const newItems = [...playerCart.items, itemToAdd];
            updateDoc(doc(db, 'shops', state.shopId), {
                [`carts.${state.characterKey}`]: { playerName: state.playerData.name, items: newItems }
            });
        }

        function handleInventoryUpdate(e) {
            const index = parseInt(e.target.dataset.index, 10);
            const field = e.target.classList.contains('dm-qty-input') ? 'quantity' : 'price';
            let value = field === 'price' ? parseFloat(e.target.value) : parseInt(e.target.value, 10);
            if (isNaN(value) || value < 0) return;
            const newInventory = [...state.shopData.inventory];
            newInventory[index] = { ...newInventory[index], [field]: value };
            state.shopData.inventory = newInventory;
            updateDoc(doc(db, 'shops', state.shopId), { inventory: newInventory });
            renderDMView();
        }

        function handleRemoveInventoryItem(e) {
            const index = parseInt(e.target.dataset.index, 10);
            const newInventory = state.shopData.inventory.filter((_, i) => i !== index);
            state.shopData.inventory = newInventory;
            updateDoc(doc(db, 'shops', state.shopId), { inventory: newInventory });
            renderDMView();
        }

        function handleAddCustomItem() {
            const nameInput = document.getElementById('custom-item-name');
            const priceInput = document.getElementById('custom-item-price');
            const qtyInput = document.getElementById('custom-item-qty');
            const name = nameInput.value.trim();
            const price = parseFloat(priceInput.value);
            const qty = parseInt(qtyInput.value, 10);
            if (!name || isNaN(price) || isNaN(qty) || qty < 0 || price < 0) return;
            const newItem = { id: `item-${Math.random().toString(36).substr(2,9)}`, name, price, quantity: qty };
            const newInventory = [...state.shopData.inventory, newItem];
            state.shopData.inventory = newInventory;
            updateDoc(doc(db, 'shops', state.shopId), { inventory: newInventory });
            nameInput.value = '';
            priceInput.value = '';
            qtyInput.value = '';
            renderDMView();
        }

        function attachDMListeners() {
            document.getElementById('shop-gold-input')?.addEventListener('change', (e) => { const newGold = parseInt(e.target.value, 10); if (!isNaN(newGold)) updateDoc(doc(db, 'shops', state.shopId), { "shopkeeper.gold": newGold }); });
            document.querySelectorAll('.checkout-btn').forEach(btn => btn.addEventListener('click', handleCheckout));
            document.querySelectorAll('.dm-qty-input, .dm-price-input').forEach(input => input.addEventListener('change', handleInventoryUpdate));
            document.querySelectorAll('.dm-remove-item-btn').forEach(btn => btn.addEventListener('click', handleRemoveInventoryItem));
            document.querySelectorAll('.price-mod-btn').forEach(btn => btn.addEventListener('click', (e) => { updateDoc(doc(db, 'shops', state.shopId), { priceModifier: parseInt(e.target.dataset.value, 10) }); }));
            document.getElementById('toggle-active-btn')?.addEventListener('click', () => { updateDoc(doc(db, 'shops', state.shopId), { active: !state.shopData.active }); });
            document.getElementById('add-custom-item-btn')?.addEventListener('click', handleAddCustomItem);
            document.getElementById('delete-shop-btn')?.addEventListener('click', async () => {
                if (confirm('Delete this shop? This cannot be undone.')) {
                    await deleteDoc(doc(db, 'shops', state.shopId));
                    exitCurrentMode();
                }
            });
        }
        function attachPlayerListeners() { 
            document.querySelectorAll('.add-to-cart-btn').forEach(btn => btn.addEventListener('click', (e) => {
                const card = e.target.closest('.item-card');
                handleAddToCart(card.dataset.itemId);
                card.classList.add('glow-once');
                setTimeout(() => card.classList.remove('glow-once'), 700);
            })); 
            document.querySelectorAll('.remove-from-cart-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const indexToRemove = parseInt(e.target.dataset.index, 10);
                    const playerCart = state.shopData.carts[state.characterKey];
                    if (!playerCart) return;
                    const newItems = playerCart.items.filter((_, i) => i !== indexToRemove);
                    updateDoc(doc(db, 'shops', state.shopId), { [`carts.${state.characterKey}.items`]: newItems });
                });
            }); 
        }

        main();
    </script>
</body>
</html>



