<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D Interactive Shop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'VT323', monospace;
            background-color: #000000;
            color: #ffffff;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
        }
        .cli-window {
            border: 2px solid #ffffff;
            padding: 1rem;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }
        .btn {
            display: inline-block;
            padding: 0.5rem 1rem;
            background-color: #ffffff;
            color: #000000;
            text-shadow: none;
            cursor: pointer;
            border: none;
            transition: all 0.2s ease-in-out;
        }
        .btn:hover:not(:disabled) {
            background-color: #000000;
            color: #ffffff;
            box-shadow: 0 0 5px #ffffff;
        }
        .btn-secondary {
             background-color: transparent;
             color: #ffffff;
             border: 1px solid #ffffff;
        }
         .btn-secondary:hover {
             background-color: #ffffff;
             color: #000000;
         }
        .btn:disabled {
            background-color: #333;
            color: #888;
            cursor: not-allowed;
            opacity: 0.7;
        }
        .input-field {
            background-color: #111;
            border: 1px solid #ffffff;
            color: #ffffff;
            padding: 0.5rem;
            width: 100%;
            font-family: 'VT323', monospace;
            text-transform: uppercase;
        }
        .input-field:focus {
            outline: none;
            box-shadow: 0 0 8px #ffffff;
        }
        .ascii-title {
              font-family: monospace; 
            white-space: pre;
            text-align: center;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }
        .blinking-cursor::after {
            content: '_';
            animation: blink 1s step-end infinite;
        }
        @keyframes blink {
            50% {
                opacity: 0;
            }
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-6 lg:p-8">

    <div id="app-container" class="max-w-7xl mx-auto relative">
        <div id="dm-controls" class="absolute top-4 right-4 hidden">
            <div class="relative inline-block text-left">
                <button id="create-shop-btn" class="btn">Create a Shop</button>
                <div id="shop-dropdown" class="hidden absolute right-0 mt-2 w-48 border border-white bg-black"></div>
            </div>
        </div>
        <!-- Initial View: Shop Selection -->
        <div id="initial-view" class="text-center">
            <div class="ascii-title">

██████╗ ███╗   ██╗██████╗     ███████╗██╗  ██╗ ██████╗ ██████╗ 
██╔══██╗████╗  ██║██╔══██╗    ██╔════╝██║  ██║██╔═══██╗██╔══██╗
██║  ██║██╔██╗ ██║██║  ██║    ███████╗███████║██║   ██║██████╔╝
██║  ██║██║╚██╗██║██║  ██║    ╚════██║██╔══██║██║   ██║██╔═══╝ 
██████╔╝██║ ╚████║██████╔╝    ███████║██║  ██║╚██████╔╝██║     
╚═════╝ ╚═╝  ╚═══╝╚═════╝     ╚══════╝╚═╝  ╚═╝ ╚═════╝ ╚═╝     
            </div>

            <div id="player-join-container" class="max-w-md mx-auto mb-8 cli-window">
                <h2 class="text-2xl mb-4">> Players: Join a Shop</h2>
                <div class="flex gap-2">
                    <input type="text" id="join-shop-id-input" class="input-field flex-grow" placeholder="ENTER SHOP ID" maxlength="6">
                    <button id="join-shop-btn" class="btn">Join</button>
                </div>
            </div>

            <p id="status-text" class="hidden text-lg mb-8 blinking-cursor"></p>
            <div id="size-selection-container" class="hidden max-w-md mx-auto grid grid-cols-3 gap-4 mb-8">
                <!-- Size selection buttons will appear here -->
            </div>
        </div>

        <!-- DM View -->
        <div id="dm-view" class="hidden">
            <!-- DM View content will be rendered here by JavaScript -->
        </div>

        <!-- Player View -->
        <div id="player-view" class="hidden">
            <!-- Player View content will be rendered here by JavaScript -->
        </div>

        <!-- Player Name Modal -->
        <div id="player-name-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
            <div class="cli-window w-11/12 max-w-md">
                <h2 class="text-2xl font-bold mb-4">> Enter Your Name</h2>
                <p class="mb-6">> Please enter your character's name to join the shop.</p>
                <input type="text" id="player-name-input" class="input-field mb-4" placeholder="e.g., Elara Swiftbow">
                <button id="submit-player-name-btn" class="btn w-full">Join Session</button>
            </div>
        </div>
    </div>
 
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, collection, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- PASTE YOUR FIREBASE CONFIG HERE ---
        const firebaseConfig = {
          apiKey: "AIzaSyA4KsHgYxihH0fgsSET1kcnONHxtlInZIE",
          authDomain: "dnd-shop-app-c4f86.firebaseapp.com",
          projectId: "dnd-shop-app-c4f86",
          storageBucket: "dnd-shop-app-c4f86.appspot.com",
          messagingSenderId: "480358969004",
          appId: "1:480358969004:web:51e08541ec64dc4b4a7909",
          measurementId: "G-DWLMWMZTZ3"
        };
        // -----------------------------------------

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- ITEM CATALOG ---
        const itemCatalog = {
          "blacksmith": { "name": "Blacksmith/Armory", "items": [ { "name": "Studded Leather", "price": 45 }, { "name": "Chain Shirt", "price": 50 }, { "name": "Scale Mail", "price": 50 }, { "name": "Breastplate", "price": 400 }, { "name": "Half Plate", "price": 750 }, { "name": "Ring Mail", "price": 30 }, { "name": "Chain Mail", "price": 75 }, { "name": "Splint", "price": 200 }, { "name": "Plate", "price": 1500 }, { "name": "Shield", "price": 10 }, { "name": "Dagger", "price": 2 }, { "name": "Handaxe", "price": 5 }, { "name": "Javelin", "price": 0.5 }, { "name": "Light Hammer", "price": 2 }, { "name": "Mace", "price": 5 }, { "name": "Sickle", "price": 1 }, { "name": "Spear", "price": 1 }, { "name": "Battleaxe", "price": 10 }, { "name": "Flail", "price": 10 }, { "name": "Glaive", "price": 20 }, { "name": "Greataxe", "price": 30 }, { "name": "Greatsword", "price": 50 }, { "name": "Halberd", "price": 20 }, { "name": "Lance", "price": 10 }, { "name": "Longsword", "price": 15 }, { "name": "Maul", "price": 10 }, { "name": "Morningstar", "price": 15 }, { "name": "Pike", "price": 5 }, { "name": "Rapier", "price": 25 }, { "name": "Scimitar", "price": 25 }, { "name": "Shortsword", "price": 10 }, { "name": "Trident", "price": 5 }, { "name": "War Pick", "price": 5 }, { "name": "Warhammer", "price": 15 }, { "name": "Ball Bearings (bag of 1,000)", "price": 1 }, { "name": "Bell", "price": 1 }, { "name": "Block and Tackle", "price": 1 }, { "name": "Chain (10 feet)", "price": 5 }, { "name": "Crowbar", "price": 2 }, { "name": "Grappling Hook", "price": 2 }, { "name": "Hammer", "price": 1 }, { "name": "Sledgehammer", "price": 2 }, { "name": "Hunting Trap", "price": 5 }, { "name": "Lamp", "price": 0.5 }, { "name": "Lantern, Bullseye", "price": 10 }, { "name": "Lantern, Hooded", "price": 5 }, { "name": "Lock", "price": 10 }, { "name": "Manacles", "price": 2 }, { "name": "Mirror, Steel", "price": 5 }, { "name": "Pick, Miner's", "price": 2 }, { "name": "Piton", "price": 0.05 }, { "name": "Pot, Iron", "price": 2 }, { "name": "Spikes, Iron", "price": 1 }, { "name": "Whetstone", "price": 0.01 }, { "name": "Carpenter's Tools", "price": 8 }, { "name": "Mason's Tools", "price": 10 }, { "name": "Smith's Tools", "price": 20 }, { "name": "Tinker's Tools", "price": 50 }, { "name": "Horn", "price": 3 } ] },
          "fletcher": { "name": "Fletcher/Bowyer", "items": [ { "name": "Crossbow, Light", "price": 25 }, { "name": "Shortbow", "price": 25 }, { "name": "Crossbow, Hand", "price": 75 }, { "name": "Crossbow, Heavy", "price": 50 }, { "name": "Longbow", "price": 50 }, { "name": "Arrows (20)", "price": 1 }, { "name": "Crossbow Bolts (20)", "price": 1 }, { "name": "Case, Crossbow Bolt", "price": 1 }, { "name": "Quiver", "price": 1 } ] },
          "leathersmith": { "name": "Leathersmith/Tanner", "items": [ { "name": "Leather", "price": 10 }, { "name": "Studded Leather", "price": 45 }, { "name": "Hide", "price": 10 }, { "name": "Shield", "price": 10 }, { "name": "Sling", "price": 0.1 }, { "name": "Waterskin", "price": 0.2 }, { "name": "Cobbler's Tools", "price": 5 }, { "name": "Leatherworker's Tools", "price": 5 }, { "name": "Bagpipes", "price": 30 }, { "name": "Drum", "price": 6 } ] },
          "temple": { "name": "Temple/Priest", "items": [ { "name": "Alms Box", "price": 5 }, { "name": "Bell", "price": 1 }, { "name": "Blanket", "price": 0.5 }, { "name": "Book, Scripture", "price": 25 }, { "name": "Candle", "price": 0.01 }, { "name": "Case, Map or Scroll", "price": 1 }, { "name": "Censer", "price": 5 }, { "name": "Chalk (1 piece)", "price": 0.01 }, { "name": "Flask", "price": 0.02 }, { "name": "Healer's Kit", "price": 5 }, { "name": "Holy Symbol, Amulet", "price": 5 }, { "name": "Holy Symbol, Emblem", "price": 5 }, { "name": "Holy Symbol, Reliquary", "price": 5 }, { "name": "Holy Water (flask)", "price": 25 }, { "name": "Incense (1 block)", "price": 0.01 }, { "name": "Ink (1 ounce bottle)", "price": 10 }, { "name": "Ink Pen", "price": 0.02 }, { "name": "Lamp", "price": 0.5 }, { "name": "Lantern, Hooded", "price": 5 }, { "name": "Oil (flask)", "price": 0.1 }, { "name": "Paper (one sheet)", "price": 0.2 }, { "name": "Parchment (one sheet)", "price": 0.1 }, { "name": "Perfume (vial)", "price": 5 }, { "name": "Potion of Healing", "price": 50 }, { "name": "Rations (1 day)", "price": 0.5 }, { "name": "Torch", "price": 0.01 }, { "name": "Vial", "price": 1 }, { "name": "Waterskin", "price": 0.2 }, { "name": "Calligrapher's Supplies", "price": 10 }, { "name": "Herbalism Kit", "price": 5 }, { "name": "Flute", "price": 2 }, { "name": "Lyre", "price": 30 }, { "name": "Horn", "price": 3 }, { "name": "Cure Wounds (lvl 1)", "price": 10, "type": "service" }, { "name": "Gentle Repose (lvl 2)", "price": 50, "type": "service" }, { "name": "Lesser Restoration (lvl 2)", "price": 50, "type": "service" }, { "name": "Remove Curse (lvl 3)", "price": 100, "type": "service" }, { "name": "Revivify (lvl 3)", "price": 400, "type": "service" }, { "name": "Raise Dead (lvl 5)", "price": 1000, "type": "service" } ] },
          "general_store": { "name": "General Store", "items": [ { "name": "Abacus", "price": 2 }, { "name": "Barrel", "price": 2 }, { "name": "Blanket", "price": 0.5 }, { "name": "Bottle, glass", "price": 2 }, { "name": "Bucket", "price": 0.05 }, { "name": "Candle", "price": 0.01 }, { "name": "Chest", "price": 5 }, { "name": "Clothes, Common", "price": 0.5 }, { "name": "Clothes, Fine", "price": 15 }, { "name": "Flask or Tankard", "price": 0.02 }, { "name": "Hammer", "price": 1 }, { "name": "Ink (1 ounce bottle)", "price": 10 }, { "name": "Ink Pen", "price": 0.02 }, { "name": "Jug or Pitcher", "price": 0.02 }, { "name": "Ladder (10-foot)", "price": 0.1 }, { "name": "Lantern, Hooded", "price": 5 }, { "name": "Lamp", "price": 0.5 }, { "name": "Lock", "price": 10 }, { "name": "Mess Kit", "price": 0.2 }, { "name": "Mirror, Steel", "price": 5 }, { "name": "Paper (one sheet)", "price": 0.2 }, { "name": "Parchment (one sheet)", "price": 0.1 }, { "name": "Pick, Miner's", "price": 2 }, { "name": "Pot, Iron", "price": 2 }, { "name": "Pouch", "price": 0.5 }, { "name": "Rope, Hempen (50 feet)", "price": 1 }, { "name": "Rope, Silk (50 feet)", "price": 10 }, { "name": "Sack", "price": 0.01 }, { "name": "Scale, Merchant's", "price": 5 }, { "name": "Shovel", "price": 2 }, { "name": "Signet Ring", "price": 5 }, { "name": "Soap", "price": 0.02 }, { "name": "Vial", "price": 1 }, { "name": "Carpenter's Tools", "price": 15 }, { "name": "Cobbler's Tools", "price": 25 }, { "name": "Cook's Utensils", "price": 50 }, { "name": "Glassblower's Tools", "price": 30 }, { "name": "Leatherworker's Tools", "price": 5 }, { "name": "Mason's Tools", "price": 10 }, { "name": "Potter's Tools", "price": 10 }, { "name": "Smith's Tools", "price": 20 }, { "name": "Weaver's Tools", "price": 1 }, { "name": "Woodcarver's Tools", "price": 1 } ] },
          "adventuring_supplies": { "name": "Adventuring Supplies", "items": [ { "name": "Padded Armor", "price": 5 }, { "name": "Leather Armor", "price": 10 }, { "name": "Studded Leather", "price": 45 }, { "name": "Hide Armor", "price": 10 }, { "name": "Club", "price": 0.1 }, { "name": "Dagger", "price": 2 }, { "name": "Greatclub", "price": 0.2 }, { "name": "Handaxe", "price": 5 }, { "name": "Light Hammer", "price": 2 }, { "name": "Quarterstaff", "price": 0.2 }, { "name": "Crossbow, Light", "price": 25 }, { "name": "Dart", "price": 0.05 }, { "name": "Shortbow", "price": 25 }, { "name": "Sling", "price": 0.1 }, { "name": "Whip", "price": 2 }, { "name": "Blowgun", "price": 10 }, { "name": "Crossbow, Hand", "price": 75 }, { "name": "Crossbow, Heavy", "price": 50 }, { "name": "Longbow", "price": 50 }, { "name": "Arrows (20)", "price": 1 }, { "name": "Blowgun Needles (50)", "price": 1 }, { "name": "Crossbow Bolts (20)", "price": 1 }, { "name": "Sling Bullets (20)", "price": 0.04 }, { "name": "Backpack", "price": 2 }, { "name": "Bedroll", "price": 1 }, { "name": "Blanket", "price": 0.5 }, { "name": "Block and Tackle", "price": 1 }, { "name": "Bottle, glass", "price": 2 }, { "name": "Candle", "price": 0.01 }, { "name": "Case, Crossbow Bolt", "price": 1 }, { "name": "Case, Map or Scroll", "price": 1 }, { "name": "Chain (10 feet)", "price": 5 }, { "name": "Chest", "price": 5 }, { "name": "Climber's Kit", "price": 25 }, { "name": "Clothes, Traveler's", "price": 2 }, { "name": "Crowbar", "price": 2 }, { "name": "Flask or Tankard", "price": 0.02 }, { "name": "Grappling Hook", "price": 2 }, { "name": "Hammer", "price": 1 }, { "name": "Healer's Kit", "price": 5 }, { "name": "Hourglass", "price": 25 }, { "name": "Hunting Trap", "price": 5 }, { "name": "Ink (1 ounce bottle)", "price": 10 }, { "name": "Ink Pen", "price": 0.02 }, { "name": "Jug or Pitcher", "price": 0.02 }, { "name": "Ladder (10-foot)", "price": 0.1 }, { "name": "Lantern, Bullseye", "price": 10 }, { "name": "Lantern, Hooded", "price": 5 }, { "name": "Lock", "price": 10 }, { "name": "Mess Kit", "price": 0.2 }, { "name": "Mirror, Steel", "price": 5 }, { "name": "Paper (one sheet)", "price": 0.2 }, { "name": "Parchment (one sheet)", "price": 0.1 }, { "name": "Pick, Miner's", "price": 2 }, { "name": "Piton", "price": 0.05 }, { "name": "Pole (10-foot)", "price": 0.05 }, { "name": "Pot, Iron", "price": 2 }, { "name": "Pouch", "price": 0.5 }, { "name": "Quiver", "price": 1 }, { "name": "Rations (1 day)", "price": 0.5 }, { "name": "Rope, Hempen (50 feet)", "price": 1 }, { "name": "Rope, Silk (50 feet)", "price": 10 }, { "name": "Sack", "price": 0.01 }, { "name": "Shovel", "price": 2 }, { "name": "Signal Whistle", "price": 5 }, { "name": "Signet Ring", "price": 5 }, { "name": "Spyglass", "price": 1000 }, { "name": "Tent, Two-person", "price": 2 }, { "name": "Tinderbox", "price": 0.5 }, { "name": "Torch", "price": 0.01 }, { "name": "Vial", "price": 1 }, { "name": "Waterskin", "price": 0.2 }, { "name": "Cartographer's Tools", "price": 15 }, { "name": "Jeweler's Tools", "price": 25 }, { "name": "Tinker's Tools", "price": 50 }, { "name": "Herbalism Kit", "price": 5 }, { "name": "Navigator's Tools", "price": 25 } ] },
          "arcane_shop": { "name": "Arcane Shop", "items": [ { "name": "Crystal", "price": 10 }, { "name": "Orb", "price": 20 }, { "name": "Rod", "price": 10 }, { "name": "Staff", "price": 5 }, { "name": "Wand", "price": 10 }, { "name": "Component Pouch", "price": 25 }, { "name": "Potion of Healing", "price": 50 }, { "name": "Spellbook", "price": 50 } ] },
          "thieves_guild": { "name": "Thieves' Guild", "items": [ { "name": "Acid (vial)", "price": 25 }, { "name": "Antitoxin (vial)", "price": 50 }, { "name": "Caltrops (bag of 20)", "price": 1 }, { "name": "Clothes, Costume", "price": 5 }, { "name": "Manacles", "price": 2 }, { "name": "Oil (flask)", "price": 0.1 }, { "name": "Poison, Basic (vial)", "price": 100 }, { "name": "Ram, Portable", "price": 4 }, { "name": "Spikes, Iron (10)", "price": 1 }, { "name": "Disguise Kit", "price": 25 }, { "name": "Forgery Kit", "price": 15 }, { "name": "Dice Set", "price": 0.1 }, { "name": "Playing Card Set", "price": 0.5 }, { "name": "Poisoner's Kit", "price": 50 }, { "name": "Thieves' Tools", "price": 25 } ] },
          "potion_shop": { "name": "Potion Shop", "items": [ { "name": "Acid (vial)", "price": 25 }, { "name": "Alchemist's Fire (flask)", "price": 50 }, { "name": "Antitoxin (vial)", "price": 50 }, { "name": "Bottle, glass", "price": 2 }, { "name": "Component Pouch", "price": 25 }, { "name": "Flask", "price": 0.02 }, { "name": "Healer's Kit", "price": 5 }, { "name": "Ink (1 ounce bottle)", "price": 10 }, { "name": "Jug", "price": 0.02 }, { "name": "Oil (flask)", "price": 0.1 }, { "name": "Perfume (vial)", "price": 5 }, { "name": "Poison, Basic (vial)", "price": 100 }, { "name": "Potion of Healing", "price": 50 }, { "name": "Vial", "price": 1 }, { "name": "Alchemist's Supplies", "price": 50 }, { "name": "Brewer's Supplies", "price": 20 }, { "name": "Cook's Utensils", "price": 1 }, { "name": "Poisoner's Kit", "price": 50 }, { "name": "Potion (Common)", "price": 50 }, { "name": "Potion (Uncommon)", "price": 250 }, { "name": "Potion (Rare)", "price": 2500 } ] }
        };

        let userId = null;
        let unsubscribe = null;
        let selectedShopKey = null;
        const apiCache = {}; // Cache for API results

        // --- STATE MANAGEMENT ---
        let state = {
            isDM: false,
            sessionId: null,
            playerName: null,
            shopData: null,
        };

        // --- DOM ELEMENTS ---
        const initialView = document.getElementById('initial-view');
        const dmView = document.getElementById('dm-view');
        const playerView = document.getElementById('player-view');
        const sizeSelectionContainer = document.getElementById('size-selection-container');
        const statusText = document.getElementById('status-text');
        const dmControls = document.getElementById('dm-controls');
        const createShopBtn = document.getElementById('create-shop-btn');
        const shopDropdown = document.getElementById('shop-dropdown');
        const playerNameModal = document.getElementById('player-name-modal');
        const playerNameInput = document.getElementById('player-name-input');
        const submitPlayerNameBtn = document.getElementById('submit-player-name-btn');
        const joinShopBtn = document.getElementById('join-shop-btn');
        const joinShopIdInput = document.getElementById('join-shop-id-input');
        
        // --- CORE FUNCTIONS ---
        
        async function main() {
            try {
                await signInAnonymously(auth);
                userId = auth.currentUser.uid;
                initializeAppLogic();
            } catch (error) {
                console.error("Authentication failed:", error);
                statusText.textContent = "Could not connect. Please check your Firebase config and internet connection.";
                statusText.classList.remove('hidden');
            }
        }

        function initializeAppLogic() {
            renderShopSelection();
            submitPlayerNameBtn.addEventListener('click', joinSession);
            playerNameInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') joinSession(); });
            joinShopBtn.addEventListener('click', handlePlayerJoinAttempt);
            joinShopIdInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') handlePlayerJoinAttempt(); });
  codex/move-create-a-new-shop-button-d1zhv8
            createShopBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                shopDropdown.classList.toggle('hidden');
            });
            document.addEventListener('click', (e) => {
                if (!dmControls.contains(e.target)) {
                    shopDropdown.classList.add('hidden');
                }
            });


        function renderShopSelection() {
            dmView.classList.add('hidden');
            playerView.classList.add('hidden');
            initialView.classList.remove('hidden');
            dmControls.classList.remove('hidden');
            statusText.textContent = '';
            statusText.classList.add('hidden');
            sizeSelectionContainer.classList.add('hidden');
            shopDropdown.classList.add('hidden');

            if (!itemCatalog) return;
            shopDropdown.innerHTML = '';
            Object.keys(itemCatalog).forEach(shopKey => {
                const shop = itemCatalog[shopKey];
                const button = document.createElement('button');
                button.className = 'block w-full text-left px-4 py-2 hover:bg-white hover:text-black';
                button.textContent = shop.name;
                button.dataset.shopKey = shopKey;
                button.addEventListener('click', () => {
                    shopDropdown.classList.add('hidden');
                    renderSizeSelection(shopKey);
                });
                shopDropdown.appendChild(button);
            });
        }

        function renderSizeSelection(shopKey) {
            selectedShopKey = shopKey;
            statusText.textContent = `> Choose a size for the ${itemCatalog[shopKey].name}.`;
            statusText.classList.remove('hidden');
            shopDropdown.classList.add('hidden');
            sizeSelectionContainer.classList.remove('hidden');

            sizeSelectionContainer.innerHTML = '';
            const sizes = ['Small', 'Urban', 'Specialty'];
            sizes.forEach(size => {
                const button = document.createElement('button');
                button.className = 'btn btn-secondary';
                button.textContent = size;
                button.addEventListener('click', () => createSession(selectedShopKey, size.toLowerCase()));
                sizeSelectionContainer.appendChild(button);
            });
        }

        async function fetchItemDetails(item) {
            const formattedName = item.name.toLowerCase().replace(/\s*\(.*\)\s*/g, '').replace(/,/g, '').replace(/\s+/g, '-');
            if (apiCache[formattedName]) {
                return { ...item, ...apiCache[formattedName] };
            }
            try {
                const response = await fetch(`https://www.dnd5eapi.co/api/equipment/${formattedName}`);
                if (!response.ok) throw new Error('Item not found in API');
                const data = await response.json();
                apiCache[formattedName] = data;
                return { ...item, ...data };
            } catch (error) {
                console.warn(`Could not fetch details for ${item.name}:`, error.message);
                return item; // Return original item if API call fails
            }
        }
        
        function generateShopId() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        async function createSession(shopKey, shopSize) {
            state.isDM = true;
            initialView.classList.add('hidden');
            dmControls.classList.add('hidden');

            const shopTemplate = itemCatalog[shopKey];
            if (!shopTemplate) {
                alert("Error: Invalid shop type selected.");
                return;
            }

            // Generate a random inventory based on size
            const fullInventory = shopTemplate.items;
            let randomInventory = [];

            if (shopSize === 'small') {
                const shuffled = fullInventory.sort(() => 0.5 - Math.random());
                const itemCount = Math.floor(Math.random() * 8) + 5; // 5 to 12 items
                randomInventory = shuffled.slice(0, itemCount);
            } else if (shopSize === 'urban') {
                const shuffled = fullInventory.sort(() => 0.5 - Math.random());
                const min = Math.ceil(fullInventory.length * 0.4);
                const max = Math.floor(fullInventory.length * 0.8);
                const itemCount = Math.floor(Math.random() * (max - min + 1)) + min;
                randomInventory = shuffled.slice(0, itemCount);
            } else if (shopSize === 'specialty') {
                const sortedByPrice = [...fullInventory].sort((a, b) => b.price - a.price);
                const itemCount = Math.floor(Math.random() * 5) + 3; // 3 to 7 items
                randomInventory = sortedByPrice.slice(0, itemCount);
            }

            const detailedInventoryPromises = randomInventory.map(fetchItemDetails);
            const detailedInventory = await Promise.all(detailedInventoryPromises);

            const finalInventory = detailedInventory.map(item => ({...item, forSale: true, id: `item-${Math.random().toString(36).substr(2, 9)}`}));
            
            state.sessionId = generateShopId();
            const newSessionRef = doc(db, 'shops', state.sessionId);

            const initialShopData = {
                shopkeeper: { name: "Awaiting Generation...", description: "", wants: "", needs: "", secrets_or_obstacles: "", carried_items: [], identifying_trait: "" },
                inventory: finalInventory,
                carts: {},
                ownerId: userId,
                shopType: `${shopTemplate.name} (${shopSize.charAt(0).toUpperCase() + shopSize.slice(1)})`
            };

            try {
                await setDoc(newSessionRef, initialShopData);
                listenToShopChanges();
            } catch (error) {
                console.error("Error creating session:", error);
                dmView.innerHTML = `<div class="cli-window"><p class="text-red-400">Error: Could not create the shop session. Please check your Firebase config and security rules.</p><p class="text-sm mt-2">${error.message}</p></div>`;
                dmView.classList.remove('hidden');
            }
        }
        
        async function handlePlayerJoinAttempt() {
            const shopId = joinShopIdInput.value.trim().toUpperCase();
            if (shopId.length !== 6) {
                alert("Please enter a valid 6-character Shop ID.");
                return;
            }

            const shopDocRef = doc(db, 'shops', shopId);
            const docSnap = await getDoc(shopDocRef);

            if (docSnap.exists()) {
                state.sessionId = shopId;
                state.isDM = false;
                initialView.classList.add('hidden');
                dmControls.classList.add('hidden');
                playerNameModal.classList.remove('hidden');
            } else {
                alert("Shop ID not found. Please check the code and try again.");
            }
        }

        function joinSession() {
            const name = playerNameInput.value.trim();
            if (!name) {
                alert("Please enter a name.");
                return;
            }
            state.playerName = name;
            playerNameModal.classList.add('hidden');
            listenToShopChanges();
        }

        function listenToShopChanges() {
            if (unsubscribe) unsubscribe(); 

            const shopDocRef = doc(db, 'shops', state.sessionId);
            unsubscribe = onSnapshot(shopDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    state.shopData = docSnap.data();
                    render();
                } else {
                    console.error("Shop session not found!");
                    document.body.innerHTML = `<div class="text-center p-8"><h1 class="text-2xl">Error: Shop Not Found</h1><p>The shop session you are trying to join does not exist. Please check the link.</p></div>`;
                }
            }, (error) => {
                console.error("Firestore listener error:", error);
                document.body.innerHTML = `<div class="text-center p-8"><h1 class="text-2xl">Connection Error</h1><p>Could not connect to the shop session. Please check your internet connection and the session link.</p></div>`;
            });
        }
        
        function render() {
            if (!state.shopData) return;

            initialView.classList.add('hidden');
            dmControls.classList.add('hidden');

            if (state.isDM) {
                dmView.classList.remove('hidden');
                playerView.classList.add('hidden');
                renderDMView();
            } else {
                playerView.classList.remove('hidden');
                dmView.classList.add('hidden');
                renderPlayerView();
            }
        }

        // --- All rendering and event handler functions remain the same below this line ---

        function renderDMView() {
            const { shopkeeper, inventory, carts, shopType } = state.shopData;
            
            dmView.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 text-lg">
                    <div class="lg:col-span-1 flex flex-col gap-6">
                        <div class="cli-window">
                            <h2 class="text-2xl mb-4">> DM Controls</h2>
                            <button id="back-to-shops-btn" class="btn btn-secondary w-full mb-4">Back to Shops</button>
                            <p class="mb-1">> Shop Type: ${shopType}</p>
                            <p class="mb-2">> Shop ID:</p>
                            <div class="flex gap-2">
                                <input type="text" readonly value="${state.sessionId}" id="session-id-input" class="input-field flex-grow">
                                <button id="copy-id-btn" class="btn btn-secondary">Copy</button>
                            </div>
                        </div>
                        <div class="cli-window">
                            <h3 class="text-2xl mb-4">> Shopkeeper</h3>
                            <button id="generate-shopkeeper-btn" class="btn w-full mb-4">Generate with AI</button>
                            <p>> Desc: ${shopkeeper.description || '...'}</p>
                            <p>> Trait: ${shopkeeper.identifying_trait || '...'}</p>
                            <p>> Wants: ${shopkeeper.wants || '...'}</p>
                            <p>> Needs: ${shopkeeper.needs || '...'}</p>
                            <p>> Secret/Obstacle: ${shopkeeper.secrets_or_obstacles || '...'}</p>
                            <p>> Carrying: ${(shopkeeper.carried_items || []).join(', ') || '...'}</p>
                            <div class="flex items-center gap-2 mt-2">
                                <p class="whitespace-nowrap">> Gold:</p>
                                <input type="number" id="shop-gold-input" value="${shopkeeper.gold}" class="input-field">
                            </div>
                        </div>
                    </div>
                    <div class="lg:col-span-1 flex flex-col gap-6">
                        <div class="cli-window">
                            <h3 class="text-2xl mb-4">> Shop Inventory</h3>
                            <div id="dm-inventory-list" class="space-y-4">
                                ${inventory.length === 0 ? '<p>Empty.</p>' : inventory.map((item, index) => `
                                    <div>
                                        <p>${item.name} - ${item.price} GP</p>
                                        <div class="flex justify-between items-center text-sm">
                                            <span>> For Sale:</span>
                                            <input type="checkbox" class="toggle-visibility-btn" data-index="${index}" ${item.forSale ? 'checked' : ''}>
                                            <button class="text-red-500 hover:text-red-400 delete-item-btn" data-index="${index}">[Delete]</button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    <div class="lg:col-span-1 flex flex-col gap-6">
                        <div class="cli-window">
                            <h3 class="text-2xl mb-4">> Player Carts</h3>
                            <div id="player-carts-list" class="space-y-4">
                                ${Object.keys(carts).length === 0 ? '<p>No active carts.</p>' : Object.entries(carts).map(([playerId, cartData]) => `
                                    <div>
                                        <h4 class="text-xl">${cartData.playerName}</h4>
                                        <ul class="pl-4">
                                            ${cartData.items.map(item => `<li>- ${item.name} (${item.price} GP)</li>`).join('')}
                                        </ul>
                                        <p class="mt-2">> Total: ${cartData.items.reduce((sum, item) => sum + item.price, 0)} GP</p>
                                        <button class="btn w-full mt-3 checkout-btn" data-player-id="${playerId}">Checkout</button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            attachDMListeners();
        }

        function renderPlayerView() {
            const { shopkeeper, inventory, carts, shopType } = state.shopData;
            const playerCart = carts[userId] || { items: [], playerName: state.playerName };
            const cartTotal = playerCart.items.reduce((sum, item) => sum + item.price, 0);

            playerView.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 text-lg">
                    <div class="lg:col-span-2">
                        <div class="cli-window mb-6">
                             <h1 class="text-3xl">${shopType}</h1>
                             <p class="text-xl">> ${shopkeeper.description || '...'}</p>
                            <p class="italic mt-2">> "${shopkeeper.identifying_trait || '...'}"</p>
                        </div>
                        <div class="cli-window">
                            <h2 class="text-2xl mb-4">> Items for Sale</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                ${inventory.filter(item => item.forSale).map(item => `
                                    <div class="border border-white/50 p-2 flex flex-col justify-between">
                                        <div>
                                            <p class="text-xl">${item.name} - ${item.price} GP</p>
                                            <div id="details-${item.id}" class="text-sm italic hidden mt-2 border-t border-white/20 pt-2">
                                                ${item.armor_class ? `<p>AC: ${item.armor_class.base}${item.armor_class.dex_bonus ? ' + Dex' : ''}</p>` : ''}
                                                ${item.damage ? `<p>Damage: ${item.damage.damage_dice}</p>` : ''}
                                                ${item.desc ? item.desc.map(d => `<p>> ${d}</p>`).join('') : ''}
                                            </div>
                                        </div>
                                        <div class="mt-auto pt-2 flex justify-end items-center gap-2">
                                            <button class="btn btn-secondary text-sm toggle-details-btn" data-item-id="${item.id}">[Details]</button>
                                            <button class="btn add-to-cart-btn" data-item-id="${item.id}">Add to Cart</button>
                                        </div>
                                    </div>
                                `).join('')}
                                ${inventory.filter(item => item.forSale).length === 0 ? '<p>Nothing for sale.</p>' : ''}
                            </div>
                        </div>
                    </div>
                    <div class="lg:col-span-1">
                        <div class="cli-window sticky top-6">
                            <h2 class="text-2xl mb-4">> Your Cart (${state.playerName})</h2>
                            <div id="player-cart-list" class="space-y-2 mb-4">
                                ${playerCart.items.length === 0 ? '<p>Your cart is empty.</p>' : playerCart.items.map((item, index) => `
                                    <div class="flex justify-between items-center">
                                        <span>- ${item.name} (${item.price} GP)</span>
                                        <button class="text-red-500 hover:text-red-400 remove-from-cart-btn" data-index="${index}">[X]</button>
                                    </div>
                                `).join('')}
                            </div>
                            <hr class="border-white/50 my-4">
                            <p class="text-xl text-right">> Total: ${cartTotal} GP</p>
                        </div>
                    </div>
                </div>
            `;
            attachPlayerListeners();
        }
        
        async function updateShop(data) {
            const shopDocRef = doc(db, 'shops', state.sessionId);
            await updateDoc(shopDocRef, data);
        }

        async function handleGenerateShopkeeperAI(e) {
            const button = e.target;
            button.disabled = true;
            button.textContent = "Generating...";

            const prompt = `Generate a unique and interesting D&D shopkeeper for a ${state.shopData.shopType || 'fantasy shop'}. Provide a brief description, their wants, their needs, their secrets or obstacles, a list of 2-3 interesting items they are carrying, and a single identifying trait (like a catchphrase, a distinct physical feature, or a mannerism).`;
            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            
            const payload = {
                contents: chatHistory,
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "description": { "type": "STRING" },
                            "wants": { "type": "STRING" },
                            "needs": { "type": "STRING" },
                            "secrets_or_obstacles": { "type": "STRING" },
                            "carried_items": { "type": "ARRAY", "items": { "type": "STRING" } },
                            "identifying_trait": { "type": "STRING" }
                        },
                        required: ["description", "wants", "needs", "secrets_or_obstacles", "carried_items", "identifying_trait"]
                    }
                }
            };

            try {
                const apiKey = ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const jsonText = result.candidates[0].content.parts[0].text;
                    const newShopkeeperData = JSON.parse(jsonText);
                    
                    const newShopkeeper = { 
                        ...state.shopData.shopkeeper, 
                        description: newShopkeeperData.description,
                        wants: newShopkeeperData.wants,
                        needs: newShopkeeperData.needs,
                        secrets_or_obstacles: newShopkeeperData.secrets_or_obstacles,
                        carried_items: newShopkeeperData.carried_items,
                        identifying_trait: newShopkeeperData.identifying_trait,
                    };
                    await updateShop({ shopkeeper: newShopkeeper });
                } else {
                    throw new Error("Invalid response structure from AI.");
                }
            } catch (error) {
                console.error("Error generating shopkeeper with AI:", error);
                alert("Failed to generate an AI shopkeeper. Please try again.");
            } finally {
                button.disabled = false;
                button.textContent = "Generate with AI";
            }
        }

        function handleUpdateGold(e) { const newGold = parseInt(e.target.value, 10); if (!isNaN(newGold)) updateShop({ "shopkeeper.gold": newGold }); }
        function handleToggleVisibility(e) { const index = parseInt(e.target.dataset.index, 10); const newInventory = [...state.shopData.inventory]; newInventory[index].forSale = e.target.checked; updateShop({ inventory: newInventory }); }
        function handleDeleteItem(e) { const index = parseInt(e.target.dataset.index, 10); const newInventory = state.shopData.inventory.filter((_, i) => i !== index); updateShop({ inventory: newInventory }); }
        function handleCheckout(e) { const playerIdToCheckout = e.target.dataset.playerId; const cart = state.shopData.carts[playerIdToCheckout]; if (!cart) return; const totalCost = cart.items.reduce((sum, item) => sum + item.price, 0); const newShopGold = state.shopData.shopkeeper.gold + totalCost; const newCarts = { ...state.shopData.carts }; delete newCarts[playerIdToCheckout]; updateShop({ carts: newCarts, "shopkeeper.gold": newShopGold }); }
        function handleAddToCart(e) { const itemId = e.target.dataset.itemId; const itemToAdd = state.shopData.inventory.find(item => item.id === itemId); if (!itemToAdd) return; const playerCart = state.shopData.carts[userId] || { items: [], playerName: state.playerName }; const newItems = [...playerCart.items, itemToAdd]; updateShop({ [`carts.${userId}`]: { playerName: state.playerName, items: newItems } }); }
        function handleRemoveFromCart(e) { const indexToRemove = parseInt(e.target.dataset.index, 10); const playerCart = state.shopData.carts[userId]; if (!playerCart) return; const newItems = playerCart.items.filter((_, i) => i !== indexToRemove); updateShop({ [`carts.${userId}.items`]: newItems }); }
        
        function handleToggleDetails(e) {
            const itemId = e.target.dataset.itemId;
            const detailsDiv = document.getElementById(`details-${itemId}`);
            if (detailsDiv) {
                detailsDiv.classList.toggle('hidden');
                e.target.textContent = detailsDiv.classList.contains('hidden') ? '[Details]' : '[Hide]';
            }
        }

        function attachDMListeners() { 
            document.getElementById('back-to-shops-btn')?.addEventListener('click', renderShopSelection);
            document.getElementById('copy-id-btn')?.addEventListener('click', () => { 
                const idInput = document.getElementById('session-id-input');
                idInput.select(); 
                document.execCommand('copy'); 
                alert('Shop ID copied to clipboard!'); 
            }); 
            document.getElementById('generate-shopkeeper-btn')?.addEventListener('click', handleGenerateShopkeeperAI); 
            document.getElementById('shop-gold-input')?.addEventListener('change', handleUpdateGold); 
            document.querySelectorAll('.toggle-visibility-btn').forEach(btn => btn.addEventListener('change', handleToggleVisibility)); 
            document.querySelectorAll('.delete-item-btn').forEach(btn => btn.addEventListener('click', handleDeleteItem)); 
            document.querySelectorAll('.checkout-btn').forEach(btn => btn.addEventListener('click', handleCheckout)); 
        }
        function attachPlayerListeners() { 
            document.querySelectorAll('.add-to-cart-btn').forEach(btn => btn.addEventListener('click', handleAddToCart)); 
            document.querySelectorAll('.remove-from-cart-btn').forEach(btn => btn.addEventListener('click', handleRemoveFromCart)); 
            document.querySelectorAll('.toggle-details-btn').forEach(btn => btn.addEventListener('click', handleToggleDetails)); 
        }

        // --- Initial Setup ---
        main();

    </script>
</body>
</html>

