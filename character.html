<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Character Sheet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=VT323&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --color-text: #e6e6e6;
        --color-header: #00ff88;
        --color-accent: #00e5ff;
        --color-price: #ffb454;
        --color-dim: #6b7280;
        --color-border: #333333;
        --shadow-glow: 0 0 8px;
      }
      html {
        scroll-behavior: smooth;
      }
      body {
        font-family: "VT323", monospace;
        background-color: #0a0a0a;
        color: var(--color-text);
        font-size: 22px;
        line-height: 1.6;
        overflow-x: hidden;
        padding-top: 5rem;
      }
      .cli-window {
        border: 1px solid var(--color-border);
        border-radius: 0.375rem;
        padding: 1rem;
        background-color: rgba(20, 20, 20, 0.9);
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
        position: relative;
      }
      .btn {
        display: inline-block;
        padding: 0.75rem 1.25rem;
        background-color: var(--color-accent);
        color: #000000;
        cursor: pointer;
        border: none;
        border-radius: 0.25rem;
        transition: all 0.2s ease-in-out;
      }
      .btn:hover:not(:disabled) {
        background-color: #000000;
        color: var(--color-accent);
        box-shadow: 0 0 5px var(--color-accent);
      }
      .btn-secondary {
        background-color: transparent;
        color: var(--color-accent);
        border: 1px solid var(--color-accent);
        border-radius: 0.25rem;
      }
      .btn-secondary:hover {
        background-color: var(--color-accent);
        color: #000000;
      }
      .text-header {
        color: var(--color-header);
        text-shadow: var(--shadow-glow) var(--color-header);
      }
      .text-item-name {
        color: var(--color-accent);
      }
      .text-price {
        color: var(--color-price);
        font-weight: bold;
      }
      .text-dim {
        color: var(--color-dim);
      }
    </style>
  </head>
  <body class="p-4 sm:p-6 lg:p-8">
    <div
      id="toolbar"
      class="fixed top-0 left-0 right-0 bg-black p-4 z-50 flex justify-between items-center h-20"
    >
      <button id="back-btn" type="button" class="btn btn-secondary">Back</button>
      <h1 class="text-2xl text-header">Character Sheet</h1>
      <button id="logout-btn" type="button" class="btn-secondary">Logout</button>
    </div>
    <main id="sheet-container" class="space-y-6 py-8 my-8 max-w-4xl mx-auto"></main>


    <script>
      document.getElementById("back-btn").addEventListener("click", () => {
        window.location.href = "index.html";
      });
      document.getElementById("logout-btn").addEventListener("click", () => {
        localStorage.removeItem("dndShopCharacterKey");
        window.location.href = "index.html";
      });

      function abilityBox(name, obj = {}) {
        const mod =
          typeof obj.mod === "number" && obj.mod >= 0
            ? `+${obj.mod}`
            : (obj.mod ?? "");
        return `<div class="flex flex-col items-center border border-white/50 p-1">
                        <div class="text-sm text-item-name">${name.slice(0, 3).toUpperCase()}</div>
                        <div class="text-xl">${obj.score ?? "-"}</div>
                        <div class="text-dim text-sm">${mod ?? ""}</div>
                    </div>`;
      }
      function saveBox(name, obj = {}) {
        return `<div class="flex flex-col items-center border border-white/50 p-1">
                    <div class="text-sm text-item-name">${name.slice(0,3).toUpperCase()}</div>
                    <div class="text-xl">${obj.save ?? "-"}</div>
                    <div class="text-dim text-sm">${obj.saveProf ? "*" : ""}</div>
                </div>`;
      }

      function renderCharacterSheet(data) {
        const abilityOrder = [
          "Strength",
          "Dexterity",
          "Constitution",
          "Intelligence",
          "Wisdom",
          "Charisma",
        ];
        const abilities = abilityOrder
          .map((n) => abilityBox(n, data.abilities?.[n] || {}))
          .join("");
        const saveBoxes = abilityOrder
          .map((n) => saveBox(n, data.abilities?.[n] || {}))
          .join("");
        const skills = Object.entries(data.skills || {})
          .map(
            ([n, o]) =>
              `<div>${n}: <span class="text-item-name">${o.bonus ?? "-"}</span>${o.prof ? " *" : ""}</div>`,
          )
          .join("");
        const attacks = (data.attacks || [])
          .map(
            (a) =>
              `<li><span class="text-item-name">${a.name}</span> ${a.atkBonus || ""} ${a.damage || ""}</li>`,
          )
          .join("");
        const money = data.equipment?.money
          ? `CP:${data.equipment.money.cp || 0} SP:${data.equipment.money.sp || 0} EP:${data.equipment.money.ep || 0} GP:${data.equipment.money.gp || 0} PP:${data.equipment.money.pp || 0}`
          : "";

        const imgSrc =
          data.avatarUrl || "https://i.imgur.com/zLRhJXx.png";
        const hpValue = data.combat?.hp ? `${data.combat.hp.current ?? "-"}/${data.combat.hp.max ?? "-"}` : "-";
        const statsLine = `Armor Class: <span class="text-item-name">${data.combat?.ac ?? "-"}</span> | Initiative: <span class="text-item-name">${data.combat?.initiative ?? "-"}</span> | Hit Points: <span class="text-item-name">${hpValue}</span> | Speed: <span class="text-item-name">${data.combat?.speed ?? "-"}</span>`;

        document.getElementById("sheet-container").innerHTML = `
                <section class="cli-window">
                    <div class="flex flex-col md:flex-row md:items-center gap-4">
                        <img src="${imgSrc}" alt="${data.charname || "Character"} image" class="w-full md:w-1/3 aspect-square object-cover border border-white/50 max-w-[12rem] md:max-w-[16rem] mx-auto md:mx-0" />
                        <div class="flex-1 text-center md:text-left">
                            <h2 class="text-2xl text-header">${data.charname || "Unknown Adventurer"}</h2>
                            <p class="text-dim">${[data.classlevel, data.race, data.alignment].filter(Boolean).join(" | ")}</p>
                            <p class="mt-2 text-2xl">${statsLine}</p>
                        </div>
                    </div>
                </section>
                <section class="cli-window">
                    <h3 class="text-2xl text-header mb-2">> Abilities</h3>
                    <div class="grid grid-cols-3 sm:grid-cols-6 gap-2">${abilities}</div>
                </section>
                <details class="cli-window">
                    <summary class="text-2xl text-header cursor-pointer">> Saving Throws</summary>
                    <div class="mt-4"><div class="grid grid-cols-3 sm:grid-cols-6 gap-2">${saveBoxes}</div></div>
                </details>
                <details class="cli-window">
                    <summary class="text-2xl text-header cursor-pointer">> Skills</summary>
                    <div class="mt-4 space-y-1">
                        ${skills || '<p class="text-dim">No skill data.</p>'}
                        ${data.passiveperception ? `<div>Passive Perception: <span class="text-item-name">${data.passiveperception}</span></div>` : ""}
                        ${data.otherprofs ? `<div>Other Profs: <span class="text-item-name">${data.otherprofs}</span></div>` : ""}
                    </div>
                </details>
                <details class="cli-window">

                    <summary class="text-2xl text-header cursor-pointer">> Attacks</summary>
                    <ul class="mt-4 list-disc pl-5">
                        ${attacks || '<li class="text-dim">No attacks.</li>'}
                    </ul>
                    ${data.attacksNotes ? `<p class="mt-2">${data.attacksNotes}</p>` : ""}
                </details>
                <details class="cli-window">
                    <summary class="text-2xl text-header cursor-pointer">> Equipment</summary>
                    <div class="mt-4">
                        ${money ? `<p>> ${money}</p>` : ""}
                        ${data.equipment?.list ? `<p class="mt-2 whitespace-pre-line">${data.equipment.list}</p>` : ''}
                    </div>
                </details>
                <details class="cli-window">
                    <summary class="text-2xl text-header cursor-pointer">> Notes</summary>
                    <div class="mt-4 space-y-2">
                        ${data.flavor?.personality ? `<p><span class="text-header">Personality:</span> ${data.flavor.personality}</p>` : ""}
                        ${data.flavor?.ideals ? `<p><span class="text-header">Ideals:</span> ${data.flavor.ideals}</p>` : ""}
                        ${data.flavor?.bonds ? `<p><span class="text-header">Bonds:</span> ${data.flavor.bonds}</p>` : ""}
                        ${data.flavor?.flaws ? `<p><span class="text-header">Flaws:</span> ${data.flavor.flaws}</p>` : ""}
                        ${data.features ? `<p><span class="text-header">Features:</span> ${data.features}</p>` : ""}
                    </div>
                </details>
            `;
      }

      async function loadCharacter() {
        const params = new URLSearchParams(window.location.search);
        const key = params.get("char") || "sample-character";
        try {
          const res = await fetch(`${key}.json`);
          if (!res.ok) throw new Error("Character not found");
          const data = await res.json();
          renderCharacterSheet(data);
        } catch (e) {
          document.getElementById("sheet-container").innerHTML =
            '<div class="cli-window text-center"><p class="text-header">Character not found.</p></div>';
        }
      }

      loadCharacter();
    </script>
  </body>
</html>
