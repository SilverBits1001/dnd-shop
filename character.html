<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Character Sheet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=VT323&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --color-text: #e0e0e0;
        --color-header: #00ff00;
        --color-accent: #00ffff;
        --color-price: #ffd700;
        --color-dim: #a0a0a0;
        --color-border: #cccccc;
        --shadow-glow: 0 0 7px;
      }
      html {
        scroll-behavior: smooth;
      }
      body {
        font-family: "VT323", monospace;
        background-color: #000000;
        color: var(--color-text);
        font-size: 20px;
        line-height: 1.6;
        overflow-x: hidden;
        padding-top: 5rem;
      }
      .cli-window {
        border: 2px solid var(--color-border);
        padding: 1rem;
        background-color: rgba(10, 10, 10, 0.4);
        box-shadow: 0 0 10px rgba(204, 204, 204, 0.3);
        opacity: 0;
        transform: translateY(20px);
        animation: fadeIn 0.5s forwards;
        position: relative;
      }
      @keyframes fadeIn {
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .btn {
        display: inline-block;
        padding: 0.75rem 1.25rem;
        background-color: #ffffff;
        color: #000000;
        cursor: pointer;
        border: none;
        transition: all 0.2s ease-in-out;
      }
      .btn:hover:not(:disabled) {
        background-color: #000000;
        color: #ffffff;
        box-shadow: 0 0 5px #ffffff;
      }
      .btn-secondary {
        background-color: transparent;
        color: #ffffff;
        border: 1px solid #ffffff;
      }
      .btn-secondary:hover {
        background-color: #ffffff;
        color: #000000;
      }
      .text-header {
        color: var(--color-header);
        text-shadow: var(--shadow-glow) var(--color-header);
      }
      .text-item-name {
        color: var(--color-accent);
      }
      .text-price {
        color: var(--color-price);
        font-weight: bold;
      }
      .text-dim {
        color: var(--color-dim);
      }
    </style>
  </head>
  <body class="p-4 sm:p-6 lg:p-8">
    <div
      id="toolbar"
      class="fixed top-0 left-0 right-0 bg-black p-4 z-50 flex justify-between items-center h-20"
    >
      <button id="back-btn" class="btn btn-secondary">Back</button>
      <h1 class="text-2xl text-header">Character Sheet</h1>
      <button id="logout-btn" class="btn-secondary">Logout</button>
    </div>
    <main id="sheet-container" class="space-y-6 py-8 my-8 max-w-4xl mx-auto"></main>

    <script>
      document.getElementById("back-btn").addEventListener("click", () => {
        window.location.href = "index.html";
      });
      document.getElementById("logout-btn").addEventListener("click", () => {
        localStorage.removeItem("dndShopCharacterKey");
        window.location.href = "index.html";
      });

      function abilityBox(name, obj = {}) {
        const mod =
          typeof obj.mod === "number" && obj.mod >= 0
            ? `+${obj.mod}`
            : (obj.mod ?? "");
        return `<div class="flex flex-col items-center border border-white/50 p-2">
                        <div class="text-sm text-item-name">${name.slice(0, 3).toUpperCase()}</div>
                        <div class="text-2xl">${obj.score ?? "-"}</div>
                        <div class="text-dim">${mod ?? ""}</div>
                    </div>`;
      }

      function renderCharacterSheet(data) {
        const abilityOrder = [
          "Strength",
          "Dexterity",
          "Constitution",
          "Intelligence",
          "Wisdom",
          "Charisma",
        ];
        const abilities = abilityOrder
          .map((n) => abilityBox(n, data.abilities?.[n] || {}))
          .join("");
        const saves = Object.entries(data.abilities || {})
          .map(
            ([n, o]) =>
              `<div>${n} Save: <span class="text-item-name">${o.save ?? "-"}</span>${o.saveProf ? " *" : ""}</div>`,
          )
          .join("");
        const skills = Object.entries(data.skills || {})
          .map(
            ([n, o]) =>
              `<div>${n}: <span class="text-item-name">${o.bonus ?? "-"}</span>${o.prof ? " *" : ""}</div>`,
          )
          .join("");
        const attacks = (data.attacks || [])
          .map(
            (a) =>
              `<li><span class="text-item-name">${a.name}</span> ${a.atkBonus || ""} ${a.damage || ""}</li>`,
          )
          .join("");
        const money = data.equipment?.money
          ? `CP:${data.equipment.money.cp || 0} SP:${data.equipment.money.sp || 0} EP:${data.equipment.money.ep || 0} GP:${data.equipment.money.gp || 0} PP:${data.equipment.money.pp || 0}`
          : "";

        const imgSrc =
          data.avatarUrl || "https://i.imgur.com/zLRhJXx.png";

        document.getElementById("sheet-container").innerHTML = `
                <div class="cli-window">
                    <h2 class="text-2xl text-header mb-1 text-center">${data.charname || "Unknown Adventurer"}</h2>
                    <p class="text-center text-dim mb-4">
                        ${[data.classlevel, data.race, data.alignment].filter(Boolean).join(" | ")}
                    </p>
                    <div class="flex flex-col md:flex-row items-center md:items-start gap-4">
                        <img src="${imgSrc}" alt="${data.charname || "Character"} image" class="w-full md:w-1/2 max-w-xs aspect-square object-cover border border-white/50 max-h-60 md:max-h-80" />
                        <div class="grid grid-cols-2 sm:grid-cols-3 gap-2 w-full md:w-1/2">${abilities}</div>
                    </div>
                </div>
                <div class="cli-window">
                    <h3 class="text-2xl text-header mb-4">> Combat</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>> AC: <span class="text-item-name">${data.combat?.ac ?? "-"}</span></div>
                        <div>> HP: <span class="text-item-name">${data.combat?.hp?.current ?? "-"} / ${data.combat?.hp?.max ?? "-"}</span></div>
                        <div>> Initiative: <span class="text-item-name">${data.combat?.initiative ?? "-"}</span></div>
                        <div>> Speed: <span class="text-item-name">${data.combat?.speed ?? "-"}</span></div>
                    </div>
                </div>
                <details class="cli-window">
                    <summary class="text-2xl text-header cursor-pointer">> Saving Throws</summary>
                    <div class="mt-4 space-y-1">
                        ${saves || '<p class="text-dim">No save data.</p>'}
                    </div>
                </details>
                <details class="cli-window">
                    <summary class="text-2xl text-header cursor-pointer">> Skills</summary>
                    <div class="mt-4 space-y-1">
                        ${skills || '<p class="text-dim">No skill data.</p>'}
                        ${data.passiveperception ? `<div>Passive Perception: <span class="text-item-name">${data.passiveperception}</span></div>` : ""}
                        ${data.otherprofs ? `<div>Other Profs: <span class="text-item-name">${data.otherprofs}</span></div>` : ""}
                    </div>
                </details>
                <details class="cli-window">
                    <summary class="text-2xl text-header cursor-pointer">> Attacks</summary>
                    <ul class="mt-4 list-disc pl-5">
                        ${attacks || '<li class="text-dim">No attacks.</li>'}
                    </ul>
                    ${data.attacksNotes ? `<p class="mt-2">${data.attacksNotes}</p>` : ""}
                </details>
                <details class="cli-window">
                    <summary class="text-2xl text-header cursor-pointer">> Equipment</summary>
                    <div class="mt-4">
                        ${money ? `<p>> ${money}</p>` : ""}
                        ${data.equipment?.list ? `<p class="mt-2 whitespace-pre-line">${data.equipment.list}</p>` : ''}
                    </div>
                </details>
                <details class="cli-window">
                    <summary class="text-2xl text-header cursor-pointer">> Notes</summary>
                    <div class="mt-4 space-y-2">
                        ${data.flavor?.personality ? `<p><span class="text-header">Personality:</span> ${data.flavor.personality}</p>` : ""}
                        ${data.flavor?.ideals ? `<p><span class="text-header">Ideals:</span> ${data.flavor.ideals}</p>` : ""}
                        ${data.flavor?.bonds ? `<p><span class="text-header">Bonds:</span> ${data.flavor.bonds}</p>` : ""}
                        ${data.flavor?.flaws ? `<p><span class="text-header">Flaws:</span> ${data.flavor.flaws}</p>` : ""}
                        ${data.features ? `<p><span class="text-header">Features:</span> ${data.features}</p>` : ""}
                    </div>
                </details>
            `;
      }

      async function loadCharacter() {
        const params = new URLSearchParams(window.location.search);
        const key = params.get("char") || "sample-character";
        try {
          const res = await fetch(`${key}.json`);
          if (!res.ok) throw new Error("Character not found");
          const data = await res.json();
          renderCharacterSheet(data);
        } catch (e) {
          document.getElementById("sheet-container").innerHTML =
            '<div class="cli-window text-center"><p class="text-header">Character not found.</p></div>';
        }
      }

      loadCharacter();
    </script>
  </body>
</html>
